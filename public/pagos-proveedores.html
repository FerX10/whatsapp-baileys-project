<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagos a Proveedores - Olas y Raíces</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <nav class="bg-white shadow-lg">
        <div class="mx-auto max-w-7xl px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fas fa-money-bill-wave text-3xl text-blue-600"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Pagos a Proveedores</h1>
                        <p class="text-sm text-gray-600">Olas y Raíces</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span id="user-name" class="text-sm text-gray-700"></span>
                    <button onclick="window.location.href='/'" class="rounded-lg bg-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-300">
                        <i class="fas fa-arrow-left mr-2"></i>Volver al CRM
                    </button>
                    <button onclick="logout()" class="rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700">
                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="mx-auto max-w-7xl px-4 py-8">
        <!-- Tabs -->
        <div class="mb-6 flex gap-2 border-b border-gray-300">
            <button id="tab-pendientes" onclick="cambiarTab('pendientes')" class="border-b-2 border-blue-600 px-4 py-2 font-medium text-blue-600">
                <i class="fas fa-clock mr-2"></i>Pendientes de Pago
            </button>
            <button id="tab-historial" onclick="cambiarTab('historial')" class="px-4 py-2 font-medium text-gray-600 hover:text-gray-800">
                <i class="fas fa-history mr-2"></i>Historial de Pagos
            </button>
            <button id="tab-proveedores" onclick="cambiarTab('proveedores')" class="px-4 py-2 font-medium text-gray-600 hover:text-gray-800">
                <i class="fas fa-building mr-2"></i>Resumen por Proveedor
            </button>
        </div>

        <!-- Tab Content: Pendientes -->
        <div id="content-pendientes" class="rounded-xl bg-white p-6 shadow-lg">
            <div class="mb-4 flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-800">Ítems Pendientes de Pago</h2>
                <div class="flex gap-2">
                    <select id="filtro-proveedor" onchange="cargarPendientes()" class="rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                        <option value="">Todos los proveedores</option>
                    </select>
                    <button onclick="cargarPendientes()" class="rounded-lg bg-blue-600 px-4 py-2 font-medium text-white hover:bg-blue-700">
                        <i class="fas fa-sync-alt mr-2"></i>Actualizar
                    </button>
                </div>
            </div>

            <div id="lista-pendientes" class="space-y-4">
                <div class="py-10 text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-600"></i>
                    <p class="mt-2">Cargando ítems pendientes...</p>
                </div>
            </div>
        </div>

        <!-- Tab Content: Historial -->
        <div id="content-historial" class="hidden rounded-xl bg-white p-6 shadow-lg">
            <div class="mb-4">
                <h2 class="text-xl font-bold text-gray-800">Historial de Pagos Realizados</h2>
            </div>
            <div id="lista-historial" class="space-y-4">
                <p class="py-10 text-center text-gray-500">Selecciona un ítem de la pestaña "Pendientes" para ver su historial</p>
            </div>
        </div>

        <!-- Tab Content: Proveedores -->
        <div id="content-proveedores" class="hidden rounded-xl bg-white p-6 shadow-lg">
            <div class="mb-4">
                <h2 class="text-xl font-bold text-gray-800">Resumen de Deuda por Proveedor</h2>
            </div>
            <div id="lista-proveedores" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                <div class="py-10 text-center text-gray-500 md:col-span-2 lg:col-span-3">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-600"></i>
                    <p class="mt-2">Cargando resúmenes...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Registrar Pago -->
    <div id="modal-pago" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4">
        <div class="w-full max-w-2xl rounded-2xl bg-white shadow-2xl">
            <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4">
                <h2 class="text-xl font-bold text-gray-800">💰 Registrar Pago a Proveedor</h2>
                <button onclick="cerrarModalPago()" class="rounded-lg p-2 text-gray-400 hover:bg-gray-100 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="form-pago" class="p-6 space-y-4">
                <input type="hidden" id="pago_item_id">

                <div class="rounded-lg bg-blue-50 p-4">
                    <h3 class="font-semibold text-gray-700 mb-2">Información del Ítem</h3>
                    <div id="info-item" class="text-sm text-gray-600"></div>
                </div>

                <div class="grid gap-4 md:grid-cols-2">
                    <div>
                        <label class="mb-1 block text-sm font-medium text-gray-700">Monto a Pagar *</label>
                        <input type="number" id="pago_monto" step="0.01" required class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    </div>
                    <div>
                        <label class="mb-1 block text-sm font-medium text-gray-700">Fecha de Pago *</label>
                        <input type="date" id="pago_fecha" required class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    </div>
                </div>

                <div>
                    <label class="mb-1 block text-sm font-medium text-gray-700">Evidencia de Pago (imagen/PDF)</label>
                    <input type="file" id="pago_evidencia" accept="image/*,.pdf" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox" id="pago_solicitar_factura" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-2 focus:ring-blue-500">
                    <label for="pago_solicitar_factura" class="text-sm font-medium text-gray-700">Solicitar factura al proveedor</label>
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox" id="pago_enviar_email" checked class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-2 focus:ring-blue-500">
                    <label for="pago_enviar_email" class="text-sm font-medium text-gray-700">Enviar notificación por email al proveedor</label>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="cerrarModalPago()" class="rounded-lg border border-gray-300 px-4 py-2 font-medium text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="rounded-lg bg-blue-600 px-4 py-2 font-medium text-white hover:bg-blue-700">
                        <i class="fas fa-check mr-2"></i>Registrar Pago
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const token = sessionStorage.getItem('token');
        const userName = sessionStorage.getItem('userName');
        const userType = sessionStorage.getItem('userType');

        if (!token || (userType !== 'admin' && userType !== 'gerente')) {
            alert('Acceso denegado. Solo administradores y gerentes pueden acceder a pagos a proveedores.');
            window.location.href = '/login';
        }

        document.getElementById('user-name').textContent = userName || 'Usuario';

        function authHeaders() {
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = '/login';
        }

        function cambiarTab(tab) {
            // Ocultar todos los contenidos
            document.getElementById('content-pendientes').classList.add('hidden');
            document.getElementById('content-historial').classList.add('hidden');
            document.getElementById('content-proveedores').classList.add('hidden');

            // Quitar estilos activos de todos los tabs
            document.getElementById('tab-pendientes').className = 'px-4 py-2 font-medium text-gray-600 hover:text-gray-800';
            document.getElementById('tab-historial').className = 'px-4 py-2 font-medium text-gray-600 hover:text-gray-800';
            document.getElementById('tab-proveedores').className = 'px-4 py-2 font-medium text-gray-600 hover:text-gray-800';

            // Activar el tab seleccionado
            document.getElementById(`tab-${tab}`).className = 'border-b-2 border-blue-600 px-4 py-2 font-medium text-blue-600';
            document.getElementById(`content-${tab}`).classList.remove('hidden');

            // Cargar datos según el tab
            if (tab === 'pendientes') cargarPendientes();
            if (tab === 'proveedores') cargarResumenProveedores();
        }

        async function cargarProveedores() {
            try {
                const res = await fetch('/api/proveedores?activos=true', { headers: authHeaders() });
                const data = await res.json();

                const select = document.getElementById('filtro-proveedor');
                select.innerHTML = '<option value="">Todos los proveedores</option>' +
                    (data.proveedores || []).map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            } catch (err) {
                console.error('Error cargando proveedores:', err);
            }
        }

        async function cargarPendientes() {
            const container = document.getElementById('lista-pendientes');
            container.innerHTML = '<div class="py-10 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-3xl text-blue-600"></i><p class="mt-2">Cargando...</p></div>';

            try {
                const proveedorId = document.getElementById('filtro-proveedor').value;
                const url = `/api/pagos-proveedores/pendientes${proveedorId ? `?proveedor_id=${proveedorId}` : ''}`;

                const res = await fetch(url, { headers: authHeaders() });
                const data = await res.json();

                if (!data.success || data.items.length === 0) {
                    container.innerHTML = '<div class="rounded-lg border-2 border-dashed border-gray-300 p-10 text-center"><i class="fas fa-check-circle text-4xl text-green-500"></i><p class="mt-3 text-gray-600 font-medium">¡No hay pagos pendientes!</p></div>';
                    return;
                }

                container.innerHTML = data.items.map(item => `
                    <div class="rounded-lg border border-gray-200 bg-white p-4 shadow-sm hover:shadow-md transition">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="rounded-full bg-blue-100 px-3 py-1 text-xs font-semibold text-blue-800">${item.folio_interno}</span>
                                    <span class="rounded-full bg-purple-100 px-3 py-1 text-xs font-semibold text-purple-800">${item.tipo}</span>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">${item.proveedor_nombre}</h3>
                                <p class="text-sm text-gray-600">Cliente: ${item.cliente_nombre}</p>
                                <div class="mt-2 flex gap-4 text-sm">
                                    <span class="text-gray-600">Costo: <strong class="text-gray-800">$${Number(item.costo_proveedor).toLocaleString('es-MX', {minimumFractionDigits: 2})}</strong></span>
                                    <span class="text-gray-600">Pagado: <strong class="text-green-600">$${Number(item.total_pagado || 0).toLocaleString('es-MX', {minimumFractionDigits: 2})}</strong></span>
                                    <span class="text-gray-600">Pendiente: <strong class="text-red-600">$${Number(item.saldo_pendiente).toLocaleString('es-MX', {minimumFractionDigits: 2})}</strong></span>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2">
                                <button onclick="abrirModalPago(${item.id}, '${item.folio_interno}', '${item.proveedor_nombre}', ${item.saldo_pendiente})" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">
                                    <i class="fas fa-money-bill mr-2"></i>Pagar
                                </button>
                                <button onclick="verHistorial(${item.id})" class="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    <i class="fas fa-history mr-2"></i>Historial
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error cargando pendientes:', err);
                container.innerHTML = '<div class="rounded-lg bg-red-50 p-4 text-red-700">Error al cargar datos: ' + err.message + '</div>';
            }
        }

        async function cargarResumenProveedores() {
            const container = document.getElementById('lista-proveedores');
            container.innerHTML = '<div class="py-10 text-center text-gray-500 md:col-span-2 lg:col-span-3"><i class="fas fa-spinner fa-spin text-3xl text-blue-600"></i><p class="mt-2">Cargando...</p></div>';

            try {
                const resProveedores = await fetch('/api/proveedores?activos=true', { headers: authHeaders() });
                const dataProveedores = await resProveedores.json();
                const proveedores = dataProveedores.proveedores || [];

                const resumenesPromises = proveedores.map(async (p) => {
                    try {
                        const res = await fetch(`/api/pagos-proveedores/resumen/${p.id}`, { headers: authHeaders() });
                        const data = await res.json();
                        return { ...p, resumen: data.resumen };
                    } catch {
                        return { ...p, resumen: null };
                    }
                });

                const proveedoresConResumen = await Promise.all(resumenesPromises);
                const proveedoresConDeuda = proveedoresConResumen.filter(p => p.resumen && p.resumen.total_adeudado > 0);

                if (proveedoresConDeuda.length === 0) {
                    container.innerHTML = '<div class="rounded-lg border-2 border-dashed border-gray-300 p-10 text-center md:col-span-2 lg:col-span-3"><i class="fas fa-check-circle text-4xl text-green-500"></i><p class="mt-3 text-gray-600 font-medium">¡Sin deudas pendientes con proveedores!</p></div>';
                    return;
                }

                container.innerHTML = proveedoresConDeuda.map(p => `
                    <div class="rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-3">${p.nombre}</h3>
                        <div class="mb-3">
                            <p class="text-sm text-gray-600">Total Adeudado</p>
                            <p class="text-2xl font-bold text-red-600">$${Number(p.resumen.total_adeudado).toLocaleString('es-MX', {minimumFractionDigits: 2})}</p>
                        </div>
                        <div class="space-y-1 border-t border-gray-200 pt-2">
                            ${p.resumen.desglose.map(d => `
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">${d.tipo} (${d.items})</span>
                                    <span class="font-medium text-gray-800">$${Number(d.total).toLocaleString('es-MX', {minimumFractionDigits: 2})}</span>
                                </div>
                            `).join('')}
                        </div>
                        ${p.email_facturacion ? `
                            <button onclick="enviarRecordatorioFacturacion(${p.id}, '${p.nombre}')" class="mt-3 w-full rounded-lg bg-purple-600 px-4 py-2 text-sm font-medium text-white hover:bg-purple-700">
                                <i class="fas fa-envelope mr-2"></i>Solicitar Facturas
                            </button>
                        ` : '<p class="mt-3 text-xs text-gray-500 text-center">Sin email de facturación configurado</p>'}
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error cargando resumen proveedores:', err);
                container.innerHTML = '<div class="rounded-lg bg-red-50 p-4 text-red-700 md:col-span-2 lg:col-span-3">Error al cargar datos: ' + err.message + '</div>';
            }
        }

        function abrirModalPago(itemId, folio, proveedor, saldo) {
            document.getElementById('pago_item_id').value = itemId;
            document.getElementById('info-item').innerHTML = `
                <p><strong>Folio:</strong> ${folio}</p>
                <p><strong>Proveedor:</strong> ${proveedor}</p>
                <p><strong>Saldo Pendiente:</strong> $${Number(saldo).toLocaleString('es-MX', {minimumFractionDigits: 2})} MXN</p>
            `;
            document.getElementById('pago_monto').value = saldo;
            document.getElementById('pago_monto').max = saldo;
            document.getElementById('pago_fecha').value = new Date().toISOString().split('T')[0];

            document.getElementById('modal-pago').classList.remove('hidden');
            document.getElementById('modal-pago').classList.add('flex');
        }

        function cerrarModalPago() {
            document.getElementById('modal-pago').classList.add('hidden');
            document.getElementById('modal-pago').classList.remove('flex');
            document.getElementById('form-pago').reset();
        }

        document.getElementById('form-pago').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('reserva_item_id', document.getElementById('pago_item_id').value);
            formData.append('monto', document.getElementById('pago_monto').value);
            formData.append('fecha_pago', document.getElementById('pago_fecha').value);
            formData.append('solicito_factura', document.getElementById('pago_solicitar_factura').checked);
            formData.append('enviar_email', document.getElementById('pago_enviar_email').checked);

            const evidencia = document.getElementById('pago_evidencia').files[0];
            if (evidencia) {
                formData.append('evidencia', evidencia);
            }

            try {
                const res = await fetch('/api/pagos-proveedores', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const data = await res.json();

                if (!data.success) throw new Error(data.message);

                alert('✅ Pago registrado exitosamente');
                cerrarModalPago();
                cargarPendientes();
            } catch (err) {
                alert('❌ Error al registrar pago: ' + err.message);
            }
        });

        async function verHistorial(itemId) {
            cambiarTab('historial');
            const container = document.getElementById('lista-historial');
            container.innerHTML = '<div class="py-10 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-3xl text-blue-600"></i><p class="mt-2">Cargando historial...</p></div>';

            try {
                const res = await fetch(`/api/pagos-proveedores/historial/${itemId}`, { headers: authHeaders() });
                const data = await res.json();

                if (!data.success || data.historial.length === 0) {
                    container.innerHTML = '<div class="rounded-lg border-2 border-dashed border-gray-300 p-10 text-center"><i class="fas fa-info-circle text-4xl text-gray-400"></i><p class="mt-3 text-gray-600">No hay pagos registrados para este ítem</p></div>';
                    return;
                }

                container.innerHTML = `
                    <div class="space-y-3">
                        ${data.historial.map(h => `
                            <div class="rounded-lg border border-gray-200 bg-white p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-semibold text-gray-800">$${Number(h.monto).toLocaleString('es-MX', {minimumFractionDigits: 2})} MXN</p>
                                        <p class="text-sm text-gray-600">${new Date(h.fecha_pago).toLocaleDateString('es-MX')}</p>
                                    </div>
                                    <div class="flex gap-2">
                                        ${h.evidencia_url ? `<a href="${h.evidencia_url}" target="_blank" class="rounded-lg bg-blue-100 px-3 py-1 text-xs font-medium text-blue-700"><i class="fas fa-file mr-1"></i>Evidencia</a>` : ''}
                                        ${h.solicito_factura ? `<span class="rounded-lg bg-purple-100 px-3 py-1 text-xs font-medium text-purple-700"><i class="fas fa-file-invoice mr-1"></i>Factura solicitada</span>` : ''}
                                        ${h.enviado_email_pagos ? `<span class="rounded-lg bg-green-100 px-3 py-1 text-xs font-medium text-green-700"><i class="fas fa-check mr-1"></i>Email enviado</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (err) {
                console.error('Error cargando historial:', err);
                container.innerHTML = '<div class="rounded-lg bg-red-50 p-4 text-red-700">Error al cargar historial: ' + err.message + '</div>';
            }
        }

        async function enviarRecordatorioFacturacion(proveedorId, nombreProveedor) {
            if (!confirm(`¿Enviar recordatorio de facturación a ${nombreProveedor}?`)) return;

            try {
                const res = await fetch(`/api/pagos-proveedores/enviar-recordatorio-facturacion/${proveedorId}`, {
                    method: 'POST',
                    headers: authHeaders()
                });

                const data = await res.json();

                if (!data.success) throw new Error(data.message);

                alert(`✅ ${data.message}\n\nPagos enviados: ${data.items_enviados}\nTotal: $${Number(data.monto_total).toLocaleString('es-MX', {minimumFractionDigits: 2})} MXN`);
                cargarResumenProveedores();
            } catch (err) {
                alert('❌ Error: ' + err.message);
            }
        }

        // Inicializar
        cargarProveedores();
        cargarPendientes();
    </script>
</body>
</html>
