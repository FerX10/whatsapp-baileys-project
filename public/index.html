<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Web Clone</title>
  <style>
    /* Nuevas animaciones */
    @keyframes messageScale {
      0% {
        transform: scale(0);
        opacity: 0;
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }


    @keyframes slideFromBottom {
      0% {
        transform: translateY(20px);
        opacity: 0;
      }

      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes typing {
      0% {
        opacity: 0.3;
      }

      50% {
        opacity: 1;
      }

      100% {
        opacity: 0.3;
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }

      100% {
        background-position: 1000px 0;
      }
    }

    /* Animaciones Base */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideIn {
      from {
        transform: translateX(-100%);
      }

      to {
        transform: translateX(0);
      }
    }

    @keyframes popIn {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes ripple {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    @keyframes pulse {
      0% {
        background-color: #f0f0f0;
      }

      50% {
        background-color: #e0e0e0;
      }

      100% {
        background-color: #f0f0f0;
      }
    }

    /* Agregar después de las animaciones base */
    :root {
      --primary-bg: #fff;
      --secondary-bg: #f0f2f5;
      --accent-color: #25D366;
      --text-primary: #333333;
      --text-secondary: #666666;
      --hover-bg: #fff9e6;
      --border-color: #ffe066;
      --message-sent: #fff3bf;
      --message-received: #ffffff;
    }

    /* Estilos base */
    body,
    html {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      height: 100%;
      background-color: var(--secondary-bg);
    }

    /* Contenedor principal */
    .whatsapp-container {
      display: flex;
      height: 100vh;
      max-width: 1600px;
      margin: 0 auto;
      background-color: var(--primary-bg);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    /* Contenedor general de la lista de chats */
    .chat-list {
      width: 400px;
      /* Ancho más grande */
      background-color: #ffffff;
      display: flex;
      flex-direction: column;
      /* Quita el border-right o ajústalo si quieres, por ejemplo: */
      border-right: none;
      height: 100vh;
      overflow: hidden;
      border-top-left-radius: 12px;
      border-bottom-left-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }


    /* Encabezado de la lista: buscador y botón nuevo */
    .chat-list-header {
      padding: 16px;
      border-bottom: 1px solid #e0e0e0;
      /* si lo mantienes, que sea muy claro */
      background-color: #fafafa;
      border-top-left-radius: 12px;
      /* coincide con .chat-list */
    }

    /* Contenedor exclusivo para los ítems de chat */
    .chat-items {
      flex: 1;
      /* Ocupa el espacio restante */
      overflow-y: auto;
      /* Habilita el scroll vertical cuando sea necesario */
      padding: 10px;
    }

    /* Scrollbar bonito para .chat-items */
    .chat-items::-webkit-scrollbar {
      width: 8px;
      /* Ancho del scrollbar */
    }

    .chat-items::-webkit-scrollbar-track {
      background: #f1f1f1;
      /* Fondo de la pista */
      border-radius: 4px;
    }

    .chat-items::-webkit-scrollbar-thumb {
      background-color: #bdbdbd;
      /* Color de la barra de scroll */
      border-radius: 4px;
      /* que sea redondeado */
      border: 2px solid transparent;
      /* algo de separación */
      background-clip: content-box;
      /* para que se vea el borde */
    }

    .chat-items::-webkit-scrollbar-thumb:hover {
      background-color: #9e9e9e;
      /* Al pasar el cursor */
    }

    .messages-container::-webkit-scrollbar {
      width: 8px;
    }

    .messages-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .messages-container::-webkit-scrollbar-thumb {
      background-color: #bbb;
      border-radius: 4px;
      border: 2px solid transparent;
      background-clip: content-box;
    }

    .messages-container::-webkit-scrollbar-thumb:hover {
      background-color: #999;
    }

    /* Ejemplo de estilo para cada ítem de chat */
    .chat-list-item {
      position: relative;
      display: flex;
      /* << clave para alinear en fila */
      align-items: center;
      gap: 12px;
      width: 100%;
      box-sizing: border-box;
      padding: 12px;
      margin-bottom: 8px;
      background-color: #fff;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }



    .chat-main-content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .chat-list-item:hover {
      transform: none;
      transform: translateY(-2px);
      background-color: #f0f0f0;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* Activo (seleccionado) */
    .chat-list-item.active {
      background-color: var(--hover-bg);
      /* un color suave */
      border-left: 4px solid var(--accent-color);
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* Anima la "cortinita" diagonal, con un before difuminado */
    .chat-list-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, transparent 0%, rgba(255, 255, 255, 0.2) 50%, transparent 100%);
      transform: translateX(-100%);
      transition: transform 0.6s;
      border-radius: 8px;
      /* que coincida con el .chat-list-item */
    }

    .chat-list-item:hover::before {
      transform: translateX(100%);
    }

    .chat-info {
      flex: 1;
      min-width: 0;
      margin-right: 10px;
    }

    .chat-right-container {
      margin-left: 10px;
    }

    .chat-tags-container {
      min-width: 120px;
      max-width: 200px;
      display: flex;
      flex-direction: column !important;
      /* Forzar dirección vertical */
      gap: 4px;
      align-items: flex-end;
      margin-left: auto;
      padding-left: 10px;
      border-left: 1px solid rgba(0, 0, 0, 0.05);
    }

    .chat-list-tag-container {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }


    .chat-list-tag {
      font-size: 10px;
      padding: 3px 10px;
      border-radius: 12px;
      color: white;
      white-space: nowrap;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
      backdrop-filter: blur(4px);
      width: fit-content;
      margin-left: auto;
      animation: fadeIn 0.3s ease-out;
    }


    .chat-phone {
      font-weight: bold;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-preview {
      color: #667781;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Mejoras visuales para las etiquetas */
    .tag:hover,
    .chat-list-tag:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
      filter: brightness(1.05);
    }

    /* Mejoras visuales adicionales */
    .chat-list-tag,
    .tag {
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      letter-spacing: 0.3px;
    }

    .chat-tags-container::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      height: 70%;
      transform: translateY(-50%);
    }

    .chat-time {
      font-size: 11px;
      color: #667781;
      min-width: 65px;
      text-align: right;
    }

    /* Ventana de chat */
    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-top-right-radius: 12px;
      border-bottom-right-radius: 12px;
      overflow: hidden;
      /* para que no se salgan contenidos */
      background-color: var(--secondary-bg);
    }


    .chat-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      /* + espacio arriba/abajo */
      min-height: 56px;
      /* asegura altura suficiente */
      box-sizing: border-box;
      line-height: 1.2;
      /* evita corte del texto */
      position: sticky;
      /* se queda arriba al hacer scroll */
      top: 0;
      z-index: 2;
      background: #f7f9fc;
      /* mismo fondo que uses en el chat */
      border-bottom: 1px solid #eaeaea;
      /* opcional, separador */
    }




    .header-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      margin-right: 15px;

    }

    .header-info {
      flex: 1;
    }

    .header-title {
      display: inline-block;
      font-size: 16px;
      font-weight: 600;
      line-height: 1.25;
      /* clave para que no se recorte */
      margin-top: 2px;
      /* pequeño empuje visual */
    }


    .sent-message,
    .received-message {
      border-radius: 12px;
      position: relative;
      transition: all 0.2s ease;

      max-width: 65%;
      margin: 8px 0;
      /* en lugar de margin-bottom: 10px; */
    }


    .sent-message:hover,
    .received-message:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .sent-message {
      background-color: #d9fdd3;
      align-self: flex-end;
      margin-left: auto;
    }

    .received-message {
      background-color: #fff;
      border: 1px solid #eee;
      align-self: flex-start;
      margin-right: auto;
    }


    .message-meta {
      font-size: 11px;
      color: #667781;
      padding: 0 12px 4px 12px;
      margin-top: 2px;
      text-align: right;
    }

    /* Barra de entrada de mensajes */
    .message-input {
      min-height: 70px;
      max-height: 200px;
      background-color: white;
      display: flex;
      align-items: flex-end;
      padding: 10px;
      border-top: 1px solid #e0e0e0;
    }

    .message-input textarea {
      flex-grow: 1;
      border: none;
      padding: 10px;
      font-size: 16px;
      outline: none;
      border-radius: 20px;
      margin-right: 10px;
      background-color: #f0f2f5;
      transition: all 0.3s ease;
      resize: none;
      min-height: 40px;
      max-height: 150px;
      overflow-y: auto;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .message-input textarea:focus {
      transform: translateY(-1px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Para compatibilidad con código antiguo */
    .message-input input {
      flex-grow: 1;
      border: none;
      padding: 10px;
      font-size: 16px;
      outline: none;
      border-radius: 5px;
      margin-right: 10px;
      background-color: #f0f2f5;
      transition: all 0.3s ease;
    }

    .message-input input:focus {
      transform: translateY(-1px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .message-input button {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      border-radius: 50%;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .message-input button:hover:not(:disabled) {
      transform: scale(1.1);
      background-color: #f0f2f5;
    }

    .message-input button::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: scale(0);
      transition: transform 0.3s ease;
    }

    .message-input button:active::after {
      transform: scale(2);
      opacity: 0;
    }

    .message-input button img {
      width: 24px;
      height: 24px;
    }

    /* Mensajes programados */
    .scheduled-message {
      background-color: #e8f4ff !important;
      position: relative;
      padding-right: 30px;
      animation: popIn 0.4s ease-out;
    }

    .scheduled-message .message-meta {
      color: #006bad;
    }

    .scheduled-info {
      font-size: 11px;
      color: #006bad;
      margin-top: 4px;
    }

    /* Notas */
    .note-message {
      background-color: #fff3cd !important;
      border: 1px solid #ffeeba;
      position: relative;
      padding-right: 30px;
      animation: popIn 0.4s ease-out;
    }

    .note-message .message-meta {
      color: #856404;
    }

    /* Emoji Picker */
    .emoji-picker {
      position: absolute;
      bottom: 70px;
      right: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: none;
      padding: 10px;
      width: 300px;
      height: 200px;
      overflow-y: auto;
      animation: fadeIn 0.2s ease-out;
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 5px;
    }

    .emoji-item {
      cursor: pointer;
      padding: 5px;
      text-align: center;
      transition: background-color 0.3s;
      border-radius: 4px;
    }

    .emoji-item:hover {
      background-color: #f0f2f5;
      transform: scale(1.2);
    }

    /* Modales */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      animation: fadeIn 0.2s ease-out;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
      max-height: 80vh;
      /* Altura máxima */
      overflow-y: auto;
      /* Permitir scroll si el contenido es muy largo */
      animation: popIn 0.3s ease-out;
    }

    /* Botones del modal */
    .schedule-submit {
      width: 100%;
      padding: 10px;
      background-color: #25D366;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .schedule-submit:hover {
      background-color: #128C7E;
      transform: translateY(-2px);
    }

    .note-submit {
      width: 100%;
      padding: 10px;
      background-color: #ffc107;
      color: #000;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .note-submit:hover {
      background-color: #e0a800;
      transform: translateY(-2px);
    }

    /* Inputs de modal */
    .scheduled-message-input,
    .note-input {
      width: 100%;
      min-height: 100px;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
      transition: all 0.3s ease;
    }

    .scheduled-message-input:focus,
    .note-input:focus {
      border-color: #25D366;
      box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);
    }

    .scheduled-message-input {
      background-color: #e8f4ff;
    }

    .note-input {
      background-color: #fff3cd;
    }

    /* Indicadores y botones especiales */
    .typing-indicator {
      display: none;
      align-items: center;
      gap: 4px;
      padding: 8px;
      color: #667781;
      font-style: italic;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      background: #667781;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    .typing-indicator.active {
      display: flex;
    }

    .delete-note,
    .delete-scheduled {
      position: absolute;
      top: 8px;
      right: 8px;

      width: 24px;
      height: 24px;
      border-radius: 50% !important;

      display: flex;
      align-items: center;
      justify-content: center;

      font-size: 14px;
      line-height: 1;
      padding: 0;
      margin: 0;
      box-sizing: border-box;

      background-color: transparent;
      /* Color del fondo para que no se vea */
      color: transparent;
      /* Oculta la "X" inicialmente */
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    /* Cuando el mouse pasa encima */
    .delete-note:hover,
    .delete-scheduled:hover {
      background-color: rgba(255, 68, 68, 0.9);
      /* Rojo al pasar el cursor */
      color: #fff;
      /* Hace visible la "X" */
    }

    .delete-note,
    .delete-scheduled {
      min-width: 24px !important;
      min-height: 24px !important;
      max-width: 24px !important;
      max-height: 24px !important;
    }




    .close {
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .close:hover {
      color: #ff4444;
      transform: scale(1.1);
    }

    /* Mensajes de estado */
    .error-message {
      background-color: #ffebee;
      color: #c62828;
      padding: 10px;
      margin: 10px;
      border-radius: 4px;
      display: none;
      animation: popIn 0.3s ease-out;
    }

    .success-message {
      background-color: #d4edda;
      color: #155724;
      padding: 10px;
      margin: 10px;
      border-radius: 4px;
      display: block;
      text-align: center;
      animation: popIn 0.3s ease-out;
    }



    /* Estilo para el buscador */
    .search-box input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.3s;
    }

    .search-box input:focus {
      border-color: #007bff;
    }

    /* Indicadores adicionales */
    .note-indicator {
      display: inline-block;
      background-color: #ffc107;
      color: #000;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      margin-left: 8px;
      animation: popIn 0.3s ease-out;
    }

    .schedule-datetime {
      display: flex;
      gap: 20px;
      margin: 15px 0;
    }

    .schedule-input {
      flex: 1;
    }

    .schedule-input label {
      display: block;
      margin-bottom: 5px;
    }

    .schedule-input input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .schedule-input input:focus {
      border-color: #25D366;
      box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);
    }

    /* Botón de cierre de sesión */
    .logout-button {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: auto;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .logout-button:hover {
      background-color: #c82333;
      transform: translateY(-2px);
    }

    /* Asegurar que el contenedor mantiene el layout correcto */
    .sent-message>*,
    .received-message>* {
      width: fit-content;
      max-width: 100%;
    }

    /* Ajustes para mensajes especiales */
    .note-message,
    .scheduled-message {
      padding-right: 30px;
      /* Espacio para el botón de eliminar */
    }

    /* Información de usuario en mensajes */
    .message-user-info {
      font-size: 12px;
      color: #128C7E;
      margin-bottom: 4px;
      font-weight: bold;
      animation: fadeIn 0.3s ease-out;
    }

    .sent-message .message-user-info {
      text-align: right;
    }

    .received-message .message-user-info {
      text-align: left;
    }

    /* Estilos de Modal Input */
    .modal-input {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }

    .modal-input:focus {
      border-color: #25D366;
      box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);
      outline: none;
    }

    .modal-submit {
      width: 100%;
      padding: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.3s ease;
    }

    .modal-submit:hover {
      background-color: #45a049;
      transform: translateY(-2px);
    }

    /* Contenedor de botones */
    .button-container {
      display: flex;
      gap: 10px;
      margin-left: auto;
    }

    .admin-button {
      background-color: #4CAF50 !important;
      transition: all 0.3s ease;
    }

    .admin-button:hover {
      background-color: #45a049 !important;
      transform: translateY(-2px);
    }

    /* Menú contenedor */
    .menu-container {
      position: relative;
      margin-left: auto;
      flex-shrink: 0;
      z-index: 1100;
      /* Asegurar que está por encima de otros elementos */
    }

    .menu-button {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 5px 10px;
      color: #444;
      transition: all 0.2s ease;
      border-radius: 50%;
      /* Botón circular */
    }

    .menu-button:hover {
      background-color: #f0f2f5;
      transform: scale(1.1);
    }

    .dropdown-menu {
      position: absolute;
      right: 0;
      top: 100%;
      background-color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      border-radius: 8px;
      min-width: 200px;
      display: none;
      /* Oculto por defecto */
      border: 1px solid #e0e0e0;
      animation: fadeIn 0.2s ease-out;
      z-index: 1300;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 10px 15px;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      transition: all 0.2s ease;
    }

    .dropdown-item:hover {
      background-color: #f5f5f5;
      transform: translateX(5px);
    }

    .dropdown-item:disabled {
      color: #999;
      cursor: not-allowed;
      transform: none;
    }

    .dropdown-item svg {
      opacity: 0.7;
      transition: all 0.2s ease;
    }

    .dropdown-item:hover svg {
      opacity: 1;
      transform: scale(1.1);
    }

    /* Separadores en el menú */
    .dropdown-item+.dropdown-item {
      border-top: 1px solid #f0f0f0;
    }

    /* Estado bloqueado para entrada de mensajes */
    .message-input.blocked {
      background-color: #f5f5f5;
      animation: fadeIn 0.3s ease-out;
    }

    .message-input.blocked input {
      color: #666;
      font-style: italic;
      cursor: not-allowed;
    }

    .message-input.blocked button {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Mejoras de scroll */
    .messages-container::-webkit-scrollbar {
      width: 6px;
    }

    .messages-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .messages-container::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 3px;
      transition: all 0.3s ease;
    }

    .messages-container::-webkit-scrollbar-thumb:hover {
      background: #666;
    }

    /* Estado de carga */
    .loading-state {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: pulse 1.5s infinite;
    }

    /* Efecto de ondulación para botones interactivos */
    .ripple {
      position: relative;
      overflow: hidden;
    }

    .ripple::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.3);
      top: 0;
      left: 0;
      pointer-events: none;
      border-radius: inherit;
    }

    /* Mejoras para dispositivos móviles */
    @media (max-width: 768px) {
      .whatsapp-container {
        flex-direction: column;
      }

      .messages-container {
        height: calc(70vh - 130px);
      }



      .chat-window {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
        /* evita que los hijos se desborden */
        overflow: hidden;
        /* opcional: si tenías sombras raras */
      }


      .sent-message,
      .received-message {
        max-width: 85%;
      }

      .modal-content {
        width: 95%;
        margin: 5% auto;
      }
    }

    /* Mejora visual para mensajes no leídos */
    .unread-message {
      position: relative;
      font-weight: bold;
    }

    .unread-message::after {
      content: '';
      position: absolute;
      right: -10px;
      top: 50%;
      width: 8px;
      height: 8px;
      background-color: #25D366;
      border-radius: 50%;
      transform: translateY(-50%);
      animation: pulse 2s infinite;
    }

    /* Efecto de scroll suave */
    .messages-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 60px;
      /* Espacio para los botones de vista */
      background-color: #f0f2f5;
      display: flex;
      flex-direction: column;
      width: 100%;
      height: calc(100vh - 200px);
      /* Ajustar según el header y el input */
    }

    /* Efecto de transición para emojis */
    .emoji-item {
      transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .emoji-item:hover {
      transform: scale(1.5) rotate(10deg);
    }

    /* Animación para notificaciones */
    .notification {
      animation: slideFromBottom 0.3s ease-out;
      background: rgba(37, 211, 102, 0.9);
      color: white;
      padding: 12px;
      border-radius: 8px;
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Mejora visual para archivos adjuntos */
    .attachment-preview {
      position: relative;
      padding: 10px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      margin-bottom: 8px;
      backdrop-filter: blur(5px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      animation: slideFromBottom 0.3s ease-out;
    }

    /* Estilos para el contenido de los mensajes */
    .message-content {
      white-space: pre-wrap !important;
      /* Forzar preservación de espacios */
      word-wrap: break-word;
      word-break: break-word;
      font-family: inherit !important;
      /* Mantener la fuente heredada */
      font-size: 14px;
      line-height: 1.4;
      margin: 0;
      padding: 8px 12px;
      background: none !important;
      /* Eliminar fondo de <pre> */
      border: none !important;
      /* Eliminar borde de <pre> */
      overflow-x: auto;
      /* Permitir scroll horizontal si es necesario */
    }

    .sent-message .message-content,
    .received-message .message-content {
      display: inline-block;
      max-width: 100%;
    }

    pre.message-content {
      font-family: inherit;
      margin: 0;
      padding: 0;
      background: none;
      border: none;
      white-space: pre-wrap;
      word-wrap: break-word;
      word-break: break-word;
    }

    /* Preservar saltos de línea y espacios */
    .message-content br {
      display: block !important;
      content: "" !important;
      margin-top: 0.5em !important;
    }

    /* Ajustar espaciado de listas */
    .message-content ul,
    .message-content ol {
      padding-left: 20px;
      margin: 8px 0;
    }

    .message-content li {
      margin: 4px 0;
    }

    .upload-button {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .upload-button:hover:not(:disabled) {
      transform: scale(1.1);
      background-color: #f0f2f5;
    }

    .upload-button img {
      width: 24px;
      height: 24px;
    }

    .media-message img:hover {
      transform: scale(1.05);
    }

    .media-message .file-info:hover {
      background-color: #f0f2f5;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* Estilos para botón de subida */
    .upload-button {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      border-radius: 50%;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .upload-button:hover:not(:disabled) {
      transform: scale(1.1);
      background-color: #f0f2f5;
    }

    .upload-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Estilos para botón de IA (mejorar texto) */
    .ai-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      padding: 10px 12px;
      cursor: pointer;
      border-radius: 50%;
      transition: all 0.3s ease;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      animation: aiButtonPulse 2s ease-in-out infinite;
    }

    @keyframes aiButtonPulse {
      0%, 100% {
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }
      50% {
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.5);
      }
    }

    .ai-button:hover:not(:disabled) {
      transform: scale(1.15) rotate(10deg);
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.6);
    }

    .ai-button:active:not(:disabled) {
      transform: scale(0.95);
    }

    .ai-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      animation: none;
    }

    .upload-button img {
      width: 24px;
      height: 24px;
    }

    /* Mejoras para la visualización de archivos */
    .media-message.loading {
      opacity: 0.7;
    }

    .media-message .file-size {
      font-size: 12px;
      color: #666;
      margin-left: 8px;
    }

    /* Indicador de progreso de carga */
    .upload-progress {
      width: 100%;
      height: 4px;
      background-color: #e9ecef;
      border-radius: 2px;
      margin-top: 5px;
      overflow: hidden;
    }

    .upload-progress-bar {
      height: 100%;
      background-color: #25D366;
      transition: width 0.3s ease;
    }

    /* Estilos para vista previa de imagen */
    .image-preview {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .image-preview img {
      max-width: 90%;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 8px;
    }

    /* Estilos para la vista previa de archivos */
    .preview-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .preview-image {
      max-width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .preview-video {
      max-width: 100%;
      max-height: 400px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .file-caption-input {
      width: 100%;
      min-height: 60px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
      font-family: inherit;
      font-size: 14px;
      margin-top: 10px;
    }

    .file-caption-input:focus {
      border-color: #25D366;
      outline: none;
      box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);
    }

    .file-info-preview {
      display: flex;
      align-items: center;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .file-info-preview .file-icon {
      font-size: 24px;
      margin-right: 10px;
    }

    .file-info-preview .file-name {
      flex-grow: 1;
      font-size: 14px;
      color: #333;
    }

    .file-info-preview .file-size {
      color: #666;
      font-size: 12px;
    }

    /* Mejoras para el modal de vista previa */
    /* Estilos mejorados para el modal de vista previa */
    #filePreviewModal .modal-content {
      max-width: 90%;
      max-height: 90vh;
      width: auto;
      margin: 5% auto;
      overflow-y: auto;
      padding: 20px;
      position: relative;
    }

    .preview-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .preview-image {
      max-width: 100%;
      max-height: 50vh;
      object-fit: contain;
      border-radius: 8px;
    }

    .preview-video {
      max-width: 100%;
      max-height: 50vh;
      border-radius: 8px;
    }

    .file-caption-input {
      width: 100%;
      min-height: 60px;
      max-height: 150px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }

    /* Estilos para archivos en el chat */
    .media-message {
      margin: 8px 0;
    }

    .media-message img {
      display: block;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
    }

    .media-message img:hover {
      transform: scale(1.05);
    }

    .file-attachment {
      display: flex;
      align-items: center;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      text-decoration: none;
      color: inherit;
      margin: 8px 0;
    }

    .text-content {
      margin-top: 8px;
      white-space: pre-wrap;
    }

    .file-info {
      margin-left: 10px;
    }

    .file-name {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .file-type {
      font-size: 12px;
      color: #666;
    }

    /* Estilos para el sistema de etiquetas */
    .tag-form {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group input[type="text"],
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-group input[type="color"] {
      width: 50px;
      height: 50px;
      padding: 0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-primary {
      background-color: #25D366;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-primary:hover {
      background-color: #128C7E;
    }

    /* Modal para las etiquetas (tag-modal) */
    .modal-content.tag-modal-content {
      width: 90%;
      max-width: 900px;
      /* más amplio que antes */
      margin-top: 3%;
      /* un poco más de espacio superior */
      padding: 20px;
      /* más espacio interno */
      border-radius: 10px;
      overflow-y: auto;
      /* si crece mucho, que se haga scroll */
      max-height: 80vh;
      /* límite de altura para no ocupar toda la pantalla */
    }

    /* Podemos mejorar la apariencia de las secciones dentro del modal */
    .tag-sections {
      display: flex;
      flex-direction: row;
      /* que esté en una fila */
      gap: 30px;
      /* separadas con más espacio */
      justify-content: space-between;
    }

    /* Ajusta cada panel del modal (tag-section) */
    .tag-section {
      flex: 1;
      background: #fefefe;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      overflow-y: auto;
      max-height: 70vh;
      /* cada sección también con scroll interno si excede */
    }

    /* Títulos dentro de cada sección */
    .tag-section h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #333;
      font-size: 18px;
    }

    /* Distinción de la lista de etiquetas */
    .tags-list {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tag-action.delete-btn {
      background: #ff4d4f;
      border: none;
      color: white;
      font-size: 14px;
      font-weight: bold;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .tag-action.delete-btn:hover {
      transform: scale(1.1);
      background-color: #ff7875;
      /* un poco más claro al pasar */
    }





    .tag-form button {
      padding: 8px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tag-form input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;

    }

    .tag-form button:hover {
      background-color: #45a049;
      transform: translateY(-2px);
    }

    .tags-list {
      max-height: 400px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tag-item {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
      margin-bottom: 8px;
      border: 2px solid transparent;
    }

    .tag-content {
      flex: 1;
      padding: 5px;
      cursor: pointer;
    }

    .tag-content:hover {
      background-color: #f5f5f5;
      border-radius: 4px;
    }

    .tag-item.assigned {
      border-color: #4CAF50;
      background-color: #f8fff8;
    }

    .tag-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tag-action.assign {
      background: #28a745;
      color: white;
    }

    .tag-action.remove {
      background: #dc3545;
      color: white;
    }

    .tag-action:hover {
      transform: scale(1.05);
    }

    .tag-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .tag-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .tag-name {
      font-size: 14px;

      flex: 1;
      font-size: 14px;
    }

    .tag-action {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tag-toggle {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background: #e9ecef;
      cursor: pointer;
      margin-right: 10px;
      transition: all 0.2s ease;
    }

    .tag-toggle.assigned {
      background-color: #dc3545;
      color: white;
    }

    .tag-toggle:hover {
      background: #dee2e6;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .tag-delete {
      background: none;
      border: none;
      color: #dc3545;
      font-size: 18px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .tag-delete:hover {
      background: #ffebee;
    }

    .chat-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
      padding: 4px;
      border-radius: 8px;
      background: transparent;
      /* Eliminado el fondo */
    }

    .chat-header>.menu-container {
      margin-left: 15px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 11px;
      color: white;
      white-space: nowrap;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
      backdrop-filter: blur(4px);
      animation: fadeIn 0.3s ease-out;
    }

    .tag:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
      filter: brightness(1.05);
    }

    .tag-modal-content {
      width: 90%;
      max-width: 800px;
    }


    .tag-sections {
      display: flex;
      gap: 20px;
    }

    .tag-section {
      flex: 1;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .tag-section h3 {
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #dee2e6;
    }

    .tag-section h4 {
      margin: 15px 0 10px 0;
    }

    /* Estilos para el view toggle */
    /* View Toggle Container */
    .view-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      /* Cambiado de right a left para no interferir */
      display: flex;
      gap: 8px;
      padding: 8px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .view-button {
      background: none;
      border: none;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .view-button img {
      width: 24px;
      height: 24px;
    }

    .view-button.active {
      background-color: #e3f2fd;
    }

    /* Table View Styles */
    .table-view {
      width: 100%;
      height: calc(100vh - 40px);
      /* Altura ajustada */
      padding: 20px;
      overflow-y: auto;
      background: #f0f2f5;
      display: none;
    }



    .chats-table {
      width: 100%;
      border-collapse: collapse;
    }

    .chats-table th,
    .chats-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .chats-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    .chats-table tbody tr {
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .chats-table tbody tr:hover {
      background-color: #f5f5f5;
    }

    .table-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .table-tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 11px;
      color: white;
      margin: 2px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Estilos adicionales para la tabla */
    .message-preview {
      max-width: 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .table-view.loading::after {
      content: 'Cargando...';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 1rem 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .chats-table th {
      white-space: nowrap;
    }

    .table-tag {
      display: inline-block;
      margin: 2px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .table-container {
        margin: 0;
        border-radius: 0;
      }

      .table-view {
        padding: 0;
      }

      .chats-table td,
      .chats-table th {
        padding: 8px;
      }

      .message-preview {
        max-width: 150px;
      }
    }

    /* Estilos para filtros y ordenamiento */
    .table-filters {
      position: sticky;
      top: 0;
      z-index: 100;
      background: white;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      max-width: 1200px;
      /* Ajustado para coincidir con table-container */
      margin-left: auto;
      margin-right: auto;
    }

    .filter-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .table-search {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .active-tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .tag-filter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag-filter {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .tag-filter input {
      display: none;
    }

    .tag-label {
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 12px;
      color: white;
      transition: all 0.2s ease;
      opacity: 0.6;
    }

    .tag-filter input:not(:checked)+.tag-label {
      opacity: 1;
      transform: scale(1.05);
    }

    .sort-indicator {
      margin-left: 4px;
      font-size: 12px;
      opacity: 0.5;
    }

    th:hover .sort-indicator {
      opacity: 1;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .table-filters {
        margin: 0;
        border-radius: 0;
      }

      .tag-filter-container {
        max-height: 100px;
        overflow-y: auto;
      }
    }

    /* Estilos para tabla vertical */
    .vertical-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }

    .vertical-table .chat-card {
      background: white;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }


    .chat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }


    .chat-card-phone {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
      margin: 0;
    }

    .chat-card-meta {
      margin-top: 4px;
      font-size: 12px;
      color: #666;
    }

    .chat-status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      background: #f0f2f5;
      font-size: 11px;
    }

    .chat-status.assigned {
      background: #e3f2fd;
      color: #1976d2;
    }

    .chat-message {
      font-size: 14px;
      color: #444;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .chat-card-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chat-card-label {
      font-size: 12px;
      color: #666;
      font-weight: 500;
    }

    .chat-card-value {
      font-size: 14px;
      color: #333;
    }

    .chat-card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .chat-card-actions {
      display: flex;
      justify-content: flex-end;
      padding: 12px 16px;
      border-top: 1px solid #eee;
      gap: 8px;
    }

    .chat-card-action {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background: #f0f2f5;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .chat-card-action:hover {
      background: #e4e6e9;
    }

    .chat-card-extra {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #eee;
      font-size: 12px;
    }

    .scheduled-preview,
    .notes-preview {
      background: #f8f9fa;
      padding: 8px;
      border-radius: 6px;
      margin-top: 8px;
    }

    .scheduled-preview {
      border-left: 3px solid #1976d2;
    }

    .notes-preview {
      border-left: 3px solid #f57c00;
    }

    .scheduled-time {
      display: block;
      color: #666;
      font-size: 11px;
      margin-top: 4px;
    }

    .chat-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }

    .chat-badge.scheduled {
      background: #e3f2fd;
      color: #1976d2;
    }

    .chat-badge.notes {
      background: #fff3e0;
      color: #f57c00;
    }

    /* Estilos base para la vista de tabla */
    .table-view {
      width: 100%;
      height: calc(100vh - 40px);
      padding: 20px;
      overflow-y: auto;
      background: #f0f2f5;
    }

    .table-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Grid para las cards */
    #tableBody {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      align-items: start;
    }

    /* Estilos de las cards */
    .chat-card {
      background: white;
      border-radius: 12px;
      margin: 0;
      padding: 0;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.05);
      height: fit-content;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      width: 100%;
    }

    .chat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .chat-card-header {
      padding: 16px;
      background: rgba(0, 0, 0, 0.02);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .chat-card-content {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Ajustes para móviles */
    @media (max-width: 768px) {
      #tableBody {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
      }

      .table-container {
        padding: 10px;
      }

      .chat-card {
        margin: 0;
      }
    }

    /* Estilos para el botón de envío masivo */
    .bulk-message-button {
      background-color: #25D366;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 16px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .bulk-message-button:hover {
      background-color: #128C7E;
      transform: translateY(-2px);
    }

    /* Estilos para el modal de envío masivo */
    /* Estilos para el modal de envío masivo */
    .bulk-message-modal {
      width: 95%;
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 !important;
      background-color: #f5f7fa;
    }

    .bulk-message-modal .modal-content {
      max-height: 90vh;
      overflow-y: auto;
      padding: 0;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Estilos para scrollbar personalizado */
    .bulk-message-modal ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .bulk-message-modal ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .bulk-message-modal ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    .bulk-message-modal ::-webkit-scrollbar-thumb:hover {
      background: #666;
    }

    /* Animaciones */
    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .bulk-message-modal {
      animation: slideIn 0.3s ease-out;
    }

    /* Estilos para los inputs y botones */
    .bulk-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      outline: none;
      transition: all 0.3s ease;
    }

    .bulk-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .bulk-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .bulk-button-primary {
      background-color: #3b82f6;
      color: white;
    }

    .bulk-button-primary:hover {
      background-color: #2563eb;
    }

    .bulk-button-secondary {
      background-color: #e5e7eb;
      color: #374151;
    }

    .bulk-button-secondary:hover {
      background-color: #d1d5db;
    }

    /* Estilos para la lista de números */
    .number-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      background-color: white;
    }

    .number-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }

    .number-item:last-child {
      border-bottom: none;
    }

    .number-item:hover {
      background-color: #f8fafc;
    }

    /* Estilos para la barra de progreso */
    .progress-bar {
      width: 100%;
      height: 6px;
      background-color: #e2e8f0;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background-color: #3b82f6;
      transition: width 0.3s ease;
    }

    /* Agregar esto a tu sección de estilos en index.html */
    .bulk-message-modal .modal-content {
      max-width: 900px;
      width: 90%;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      margin: 20px auto;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .bulk-message-modal input,
    .bulk-message-modal textarea {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .bulk-message-modal button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .bulk-message-modal button.primary {
      background-color: #25D366;
      color: white;
    }

    .bulk-message-modal button.secondary {
      background-color: #f0f2f5;
      color: #333;
    }

    .bulk-message-modal .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .bulk-message-modal .step {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 10px;
      background-color: #f0f2f5;
    }

    .bulk-message-modal .step.active {
      background-color: #25D366;
      color: white;
    }

    .dropdown-item:hover {
      background-color: #f5f5f5;
      transform: translateX(5px);
    }

    /* Estilos para el switch del asistente */
    .assistant-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 15px;
      width: 100%;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      transition: all 0.3s ease;
      position: relative;
    }

    .assistant-toggle .switch-container {
      display: inline-flex;
      align-items: center;
      margin-left: auto;
    }

    .assistant-toggle .switch {
      position: relative;
      width: 44px;
      height: 24px;
      background-color: #ccc;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .assistant-toggle.active .switch {
      background-color: #4CAF50;
    }

    .assistant-toggle .switch::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      background-color: white;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .assistant-toggle.active .switch::before {
      transform: translateX(20px);
    }

    .assistant-toggle:hover {
      background-color: #f5f5f5;
    }

    .assistant-toggle .switch-label {
      font-size: 14px;
      margin-right: 8px;
      color: #666;
    }

    .assistant-toggle.active .switch-label {
      color: #4CAF50;
    }

    .assistant-toggle .robot-icon {
      font-size: 18px;
      margin-right: 8px;
      opacity: 0.7;
      transition: all 0.3s ease;
    }

    .assistant-toggle.active .robot-icon {
      opacity: 1;
      color: #4CAF50;
    }

    #newChatButtonContainer {
      padding: 8px 15px;
      border-bottom: 1px solid #e0e0e0;
      position: relative;
      z-index: 2;
    }

    #newChatButtonContainer button {
      width: 100%;
      text-align: left;
      padding: 10px 15px;
      background-color: #f0f2f5;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
    }

    #newChatButtonContainer button:hover {
      background-color: #e0e2e5;
      transform: translateY(-1px);
    }

    .search-box {
      padding: 10px;
      background-color: #f0f2f5;
      border-bottom: 1px solid #e0e0e0;
      position: sticky;
      top: 0;
      z-index: 1;
    }



    /* Estilos para el modal de WhatsApp QR */
    .whatsapp-qr-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .whatsapp-qr-modal .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      animation: slideIn 0.3s ease-out;
    }

    .qr-header {
      margin-bottom: 20px;
    }

    .qr-header h2 {
      color: #075e54;
      font-size: 24px;
      margin-bottom: 10px;
    }

    .qr-header p {
      color: #666;
      font-size: 16px;
    }

    .qr-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin: 20px auto;
      width: fit-content;
    }

    .qr-container svg {
      width: 256px;
      height: 256px;
    }

    .qr-instructions {
      text-align: left;
      margin-top: 20px;
      padding: 15px;
      background: #f0f2f5;
      border-radius: 8px;
    }

    .qr-instructions ol {
      margin: 0;
      padding-left: 20px;
    }

    .qr-instructions li {
      color: #666;
      margin: 10px 0;
      line-height: 1.4;
    }

    /* Indicador de estado de WhatsApp */
    .whatsapp-status {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 10px;
    }

    .whatsapp-status::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .whatsapp-status.connected {
      background-color: #dcf8c6;
      color: #075e54;
    }

    .whatsapp-status.connected::before {
      background-color: #25d366;
    }

    .whatsapp-status.disconnected {
      background-color: #fdd;
      color: #c62828;
    }

    .whatsapp-status.disconnected::before {
      background-color: #c62828;
    }

    .header-status-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
    }

    .whatsapp-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      transition: all 0.3s ease;
    }

    .whatsapp-status .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      transition: background-color 0.3s ease;
    }

    .whatsapp-status.connected {
      background-color: rgba(37, 211, 102, 0.1);
    }

    .whatsapp-status.connected .status-dot {
      background-color: #25d366;
    }

    .whatsapp-status.connected .status-text {
      color: #075e54;
    }

    .whatsapp-status.disconnected {
      background-color: rgba(239, 68, 68, 0.1);
    }

    .whatsapp-status.disconnected .status-dot {
      background-color: #ef4444;
    }

    .whatsapp-status.disconnected .status-text {
      color: #c62828;
    }

    /* Animación para la burbuja: pulso */
    @keyframes badgePulse {
      0% {
        transform: scale(1);
        opacity: 0.8;
      }

      50% {
        transform: scale(1.2);
        opacity: 1;
      }

      100% {
        transform: scale(1);
        opacity: 0.8;
      }
    }

    /* Estilo para la burbuja de mensaje nuevo */
    .new-message-badge {
      background-color: #25D366;
      /* Verde */
      color: white;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 12px;
      position: absolute;
      top: 8px;
      right: 8px;
      min-width: 20px;
      text-align: center;
      animation: badgePulse 1.5s infinite;
    }

    .new-message-badge {
      transition: opacity 0.3s ease-out;
    }

    @keyframes fadeOutScale {
      0% {
        opacity: 1;
        transform: scale(1);
      }

      100% {
        opacity: 0;
        transform: scale(0.5);
      }
    }

    .fade-out {
      animation: fadeOutScale 0.3s ease-out forwards;
    }

    /* --------------------------------------------- */
    /* EJEMPLO DE SPINNER */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #09f;
      animation: spin 1s ease infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* --------------------------------------------- */
    .chat-list-tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 5px;
      margin-left: auto;
      /* << empuja a la derecha */
      align-self: flex-start;
      /* << alinea arriba para no “bailar” */
    }
  </style>
</head>

<body>
  <!-- === Modales globales (pueden ir fuera del container) === -->
  <div id="filePreviewModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div class="preview-container">
        <div id="filePreview"></div>
        <textarea id="fileCaption" placeholder="Agregar un mensaje..." class="file-caption-input"></textarea>
      </div>
      <button onclick="sendFileWithCaption()" class="modal-submit">Enviar</button>
    </div>
  </div>

  <div id="noteModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Crear Nota Interna</h2>
      <textarea id="noteText" placeholder="Escribe tu nota aquí..." class="note-input"></textarea>
      <button onclick="saveNote()" class="note-submit">Guardar Nota</button>
    </div>
  </div>

  <div id="reservaModal" class="modal">
    <div class="modal-content" style="max-width:520px">
      <span class="close" onclick="toggleReservaModal(false)">&times;</span>
      <h2>Nueva Reserva</h2>

      <div class="form-group">
        <label>Contacto (ID)</label>
        <input type="number" id="reservaContactoId" class="modal-input" placeholder="ID en contactos.id">
      </div>

      <div class="form-group">
        <label>Destino</label>
        <input type="text" id="reservaDestino" class="modal-input" placeholder="Ej: Cancún">
      </div>

      <div class="form-group">
        <label>Método de pago</label>
        <select id="reservaMetodo" class="modal-input">
          <option value="EFECTIVO">EFECTIVO</option>
          <option value="TARJETA">TARJETA</option>
          <option value="TRANSFERENCIA">TRANSFERENCIA</option>
        </select>
      </div>

      <div class="form-group" style="display:grid; gap:8px;">
        <label>Ítem 1 (proveedor, tipo, neto, cliente)</label>
        <input type="number" id="reservaProv1" class="modal-input" placeholder="proveedor_id">
        <input type="text" id="reservaTipo1" class="modal-input" placeholder="HOTEL | BUS | VUELO | ...">
        <input type="number" id="reservaNeto1" class="modal-input" placeholder="precio_neto">
        <input type="number" id="reservaCliente1" class="modal-input" placeholder="precio_cliente">
      </div>

      <button class="modal-submit" onclick="submitReserva()">Crear</button>
    </div>
  </div>

  <!-- Modal Nueva Reserva (Tailwind) -->
  <div id="modalNuevaReserva" class="fixed inset-0 z-50 items-center justify-center bg-black/50 p-4" style="display:none">
    <div class="w-full max-w-4xl rounded-2xl bg-white shadow-2xl" style="max-height:90vh; display:flex; flex-direction:column">
      <!-- Header -->
      <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4" style="flex-shrink:0">
        <h2 class="text-xl font-bold text-gray-800">🆕 Nueva Reserva</h2>
        <button onclick="document.getElementById('modalNuevaReserva').style.display='none'"
                class="rounded-lg p-2 text-gray-400 transition hover:bg-gray-100 hover:text-gray-600">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Body (scrollable) -->
      <div class="overflow-y-auto px-6 py-4" style="flex:1">
        <form id="formNuevaReserva" class="space-y-6">
          <!-- Botón Auto-rellenar desde cotizaciones -->
          <div class="flex justify-end">
            <button type="button" id="btn_autorellenar_coti" class="inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-purple-600 to-blue-600 px-4 py-2 text-sm font-medium text-white shadow-md hover:from-purple-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Auto-rellenar desde cotización
            </button>
          </div>

          <!-- Datos del cliente -->
          <div class="rounded-xl border border-gray-200 bg-gradient-to-br from-blue-50 to-white p-4">
            <h3 class="mb-3 flex items-center gap-2 text-sm font-semibold text-gray-700">
              <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              Datos del Cliente
            </h3>
            <div class="grid gap-4 md:grid-cols-2">
              <div>
                <label class="mb-1 block text-sm font-medium text-gray-700">Cliente</label>
                <input type="text" id="nr_cliente_search" list="nr_clientes_datalist" placeholder="Buscar cliente por nombre o teléfono..."
                       class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200">
                <datalist id="nr_clientes_datalist"></datalist>
                <input type="hidden" id="nr_cliente_select">
                <input type="hidden" id="nr_cliente_nombre">
                <input type="hidden" id="nr_cliente_tel">
              </div>
              <div>
                <label class="mb-1 block text-sm font-medium text-gray-700">Teléfono</label>
                <input type="text" id="nr_cliente_tel_display" readonly
                       class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 text-gray-700">
              </div>
              <div id="nr_vendedor_container" class="md:col-span-2" style="display:none">
                <label class="mb-1 block text-sm font-medium text-gray-700">Vendedor Asignado</label>
                <select id="nr_vendedor_id" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                  <option value="">Cargando vendedores...</option>
                </select>
              </div>
            </div>
            <input type="hidden" id="nr_contacto_id">
          </div>

          <!-- Folios -->
          <div class="rounded-xl border border-gray-200 bg-white p-4">
            <h3 class="mb-3 flex items-center gap-2 text-sm font-semibold text-gray-700">
              <svg class="h-5 w-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
              </svg>
              Folios
            </h3>
            <div class="grid gap-4 md:grid-cols-2">
              <div>
                <label class="mb-1 block text-sm font-medium text-gray-700">Folio Interno</label>
                <input type="text" id="nr_folio_interno"
                       class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                <p class="mt-1 text-xs text-gray-500">Se genera automáticamente, puedes modificarlo después</p>
              </div>
              <div>
                <label class="mb-1 block text-sm font-medium text-gray-700">Folio Proveedor (opcional)</label>
                <input type="text" id="nr_folio_proveedor" placeholder="Agregar después de reservar en el portal"
                       class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
              </div>
            </div>
          </div>

          <!-- Datos del viaje -->
          <div class="rounded-xl border border-gray-200 bg-white p-4">
            <h3 class="mb-3 flex items-center gap-2 text-sm font-semibold text-gray-700">
              <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Datos del Viaje
            </h3>
            <div class="grid gap-4 md:grid-cols-2">
              <div>
                <label class="mb-1 block text-sm font-medium text-gray-700">Destino *</label>
                <input type="text" id="nr_destino" required
                       class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
              </div>
              <div>
                <label class="mb-1 block text-sm font-medium text-gray-700">Método de Pago *</label>
                <select id="nr_metodo_pago" required
                        class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                  <option value="EFECTIVO">💵 EFECTIVO</option>
                  <option value="TRANSFERENCIA">🏦 TRANSFERENCIA</option>
                  <option value="TARJETA">💳 TARJETA</option>
                </select>
              </div>
              <div>
                <label class="mb-1 block text-sm font-medium text-gray-700">Check-in</label>
                <input type="date" id="nr_check_in"
                       class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
              </div>
              <div>
                <label class="mb-1 block text-sm font-medium text-gray-700">Check-out</label>
                <input type="date" id="nr_check_out"
                       class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
              </div>
            </div>
          </div>

          <!-- Ocupación y Pasajeros -->
          <div class="rounded-xl border border-gray-200 bg-white p-4">
            <h3 class="mb-3 flex items-center gap-2 text-sm font-semibold text-gray-700">
              <svg class="h-5 w-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
              Pasajeros
            </h3>

            <!-- Adultos -->
            <div class="mb-4">
              <div class="mb-2 flex items-center justify-between">
                <label class="text-sm font-medium text-gray-700">Adultos</label>
                <button type="button" onclick="agregarAdulto()" class="rounded-lg bg-green-600 px-3 py-1 text-xs text-white hover:bg-green-700">+ Agregar Adulto</button>
              </div>
              <div id="nr_adultos_container" class="space-y-2">
                <!-- Se llenan dinámicamente -->
              </div>
            </div>

            <!-- Menores -->
            <div>
              <div class="mb-2 flex items-center justify-between">
                <label class="text-sm font-medium text-gray-700">Menores</label>
                <button type="button" onclick="agregarMenor()" class="rounded-lg bg-blue-600 px-3 py-1 text-xs text-white hover:bg-blue-700">+ Agregar Menor</button>
              </div>
              <div id="nr_menores_container" class="space-y-2">
                <!-- Se llenan dinámicamente -->
              </div>
            </div>
          </div>

          <!-- Item inicial (opcional) -->
          <div class="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-4">
            <h3 class="mb-3 flex items-center gap-2 text-sm font-semibold text-gray-700">
              <svg class="h-5 w-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              Ítem Inicial (Opcional)
            </h3>
            <div class="grid gap-4 md:grid-cols-2">
              <div>
                <label class="mb-1 block text-sm font-medium text-gray-700">Proveedor</label>
                <select id="nr_proveedor_id" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                  <option value="">Cargando proveedores...</option>
                </select>
              </div>
              <div>
                <label class="mb-1 block text-sm font-medium text-gray-700">Tipo</label>
                <select id="nr_tipo_item"
                        class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                  <option value="">(sin ítem por ahora)</option>
                  <option value="HOTEL">🏨 HOTEL</option>
                  <option value="TRANSPORTE">🚌 TRANSPORTE (Camión)</option>
                  <option value="VUELO">✈️ VUELO</option>
                  <option value="TRASLADO">🚐 TRASLADO</option>
                  <option value="HOTEL_TRANSPORTE">🏨🚌 HOTEL + TRANSPORTE</option>
                  <option value="HOTEL_VUELO_TRASLADO">🏨✈️🚐 HOTEL + VUELO + TRASLADO</option>
                  <option value="PUEBLO_MAGICO">🏘️ PUEBLO MÁGICO</option>
                  <option value="OTRO">📦 OTRO</option>
                </select>
              </div>
              <div class="md:col-span-2">
                <label class="mb-1 block text-sm font-medium text-gray-700">Descripción</label>
                <input type="text" id="nr_desc_item" placeholder="Ej: Hotel X 3 noches AI"
                       class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
              </div>
              <div>
                <label class="mb-1 block text-sm font-medium text-gray-700">Precio Neto</label>
                <input type="number" step="0.01" id="nr_precio_neto"
                       class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
              </div>
              <div>
                <label class="mb-1 block text-sm font-medium text-gray-700">Precio Cliente</label>
                <input type="number" step="0.01" id="nr_precio_cliente"
                       class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Footer -->
      <div class="flex items-center justify-end gap-3 border-t border-gray-200 px-6 py-4" style="flex-shrink:0">
        <button type="button" onclick="document.getElementById('modalNuevaReserva').style.display='none'"
                class="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50">
          Cancelar
        </button>
        <button type="submit" form="formNuevaReserva"
                class="rounded-lg bg-blue-600 px-6 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-700">
          💾 Guardar Reserva
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Seleccionar Cotización -->
  <div id="modalSeleccionarCotizacion" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:16px; max-width:900px; width:90%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,0.3);">

      <!-- Header -->
      <div style="padding:24px 32px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h2 style="margin:0; font-size:24px; font-weight:700; color:white; display:flex; align-items:center; gap:12px;">
          <svg style="width:28px; height:28px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Seleccionar Cotización
        </h2>
        <button onclick="document.getElementById('modalSeleccionarCotizacion').style.display='none'" style="background:rgba(255,255,255,0.2); border:none; color:white; width:32px; height:32px; border-radius:50%; cursor:pointer; font-size:20px; display:flex; align-items:center; justify-content:center; transition:all 0.2s;">
          ✕
        </button>
      </div>

      <!-- Search bar -->
      <div style="padding:20px 32px; border-bottom:1px solid #e5e7eb; background:#f9fafb;">
        <input type="text" id="cotizacion_search" placeholder="🔍 Buscar por destino, fecha..." style="width:100%; padding:12px 16px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; outline:none;" oninput="filtrarCotizaciones()">
      </div>

      <!-- Lista de cotizaciones -->
      <div id="cotizaciones_list" style="flex:1; overflow-y:auto; padding:24px 32px;">
        <div style="text-align:center; color:#9ca3af; padding:60px 20px;">
          <svg style="width:64px; height:64px; margin:0 auto 16px; opacity:0.3;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p style="font-size:16px; margin:0;">Cargando cotizaciones...</p>
        </div>
      </div>

      <!-- Footer -->
      <div style="padding:20px 32px; border-top:1px solid #e5e7eb; background:#f9fafb; display:flex; justify-content:space-between; align-items:center;">
        <span id="cotizaciones_count" style="color:#6b7280; font-size:14px;">0 cotizaciones disponibles</span>
        <button onclick="document.getElementById('modalSeleccionarCotizacion').style.display='none'" style="padding:10px 24px; background:#6b7280; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:500; transition:all 0.2s;">
          Cancelar
        </button>
      </div>

    </div>
  </div>

  <!-- === Contenedor principal WhatsApp === -->
  <div class="whatsapp-container">
    <!-- Columna izquierda -->
    <div class="chat-list" id="chatList">
      <!-- Encabezado fijo: buscador y botón de nuevo chat -->
      <div class="chat-list-header">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Buscar chat">
        </div>
        <div id="newChatButtonContainer"></div>
      </div>

      <!-- INICIO SPINNER DE CARGA CHATLIST -->
      <div id="chatListSpinner" style="display:none; text-align: center; padding: 10px;">
        <div class="spinner"></div>
        <p style="color: #666; font-size: 14px;">Cargando chats...</p>
      </div>
      <!-- FIN SPINNER DE CARGA CHATLIST -->

      <!-- Contenedor desplazable para los ítems de chat -->
      <div class="chat-items">
        <!-- Aquí se cargarán los ítems de chat -->
      </div>
    </div>

    <!-- Columna derecha (ENVUELTA en .chat-window) -->
    <div class="chat-window">
      <div class="chat-header" id="chatHeader">
        <div>
          Selecciona un chat
          <div class="last-seen" id="lastSeen"></div>
        </div>
      </div>

      <div id="errorMessage" class="error-message"></div>

      <div class="messages-container" id="messagesContainer"></div>

      <!-- Indicador de escritura -->
      <div class="typing-indicator">
        <span>Escribiendo</span>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>

      <!-- Emoji picker -->
      <div class="emoji-picker" id="emojiPicker">
        <div class="emoji-grid" id="emojiGrid"></div>
      </div>

      <!-- Input de mensaje -->
      <div class="message-input">
        <button onclick="toggleEmojiPicker()" id="emojiButton">😊</button>
        <textarea id="messageInput" placeholder="Escribe un mensaje (Shift+Enter para nueva línea)" disabled rows="1"></textarea>
        <button onclick="mejorarTextoConIA()" id="aiButton" class="ai-button" title="Mejorar con IA ✨" disabled>✨</button>
        <button onclick="toggleScheduleMessage()" id="scheduleButton" class="schedule-button" disabled>
          <img src="/img/clock.png" alt="Reloj">
        </button>
        <button onclick="sendMessage()" id="sendButton" disabled>
          <img src="/img/send.png" alt="Enviar">
        </button>
        <button onclick="document.getElementById('bulkFileInput').click()" id="uploadButton" class="upload-button"
          disabled>
          <img src="/img/upload.png" alt="Subir archivo">
        </button>
        <input type="file" id="bulkFileInput" name="file" style="display: none" accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx" onchange="handleFileUpload(event)">
        <button onclick="toggleNoteModal()" id="noteButton" class="note-button" disabled>
          <img src="/img/note.png" alt="Nota">
        </button>
      </div>

      <!-- Modal de programación (puede estar aquí, es fixed) -->
      <div id="scheduleModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2>Programar Mensaje</h2>
          <textarea id="scheduledMessage" placeholder="Escribe tu mensaje programado aquí..."
            class="scheduled-message-input"></textarea>
          <div class="schedule-datetime">
            <div class="schedule-input">
              <label>Fecha:</label>
              <input type="date" id="scheduleDate">
            </div>
            <div class="schedule-input">
              <label>Hora:</label>
              <input type="time" id="scheduleTime">
            </div>
          </div>
          <button onclick="scheduleMessage()" class="schedule-submit">Programar Mensaje</button>
        </div>
      </div>
    </div> <!-- /.chat-window -->
  </div> <!-- /.whatsapp-container -->

  <!-- Toggle de vista -->
  <div class="view-toggle">
    <button id="chatViewBtn" class="view-button active">
      <img src="/img/chat.png" alt="Chat">
    </button>
    <button id="tableViewBtn" class="view-button">
      <img src="/img/table.png" alt="Tabla">
    </button>
  </div>

  <!-- Vista de tabla -->
  <div id="tableView" class="table-view">
    <div class="table-container">
      <table class="chats-table">
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal de etiquetas -->
  <div id="tagModal" class="modal">
    <div class="modal-content tag-modal-content">
      <span class="close">&times;</span>
      <div class="tag-sections">
        <div class="tag-section">
          <h3>Agregar Nueva Etiqueta</h3>
          <form class="tag-form">
            <div class="form-group">
              <input type="text" id="newTagName" class="modal-input" placeholder="Nombre de la etiqueta" required>
            </div>
            <div class="form-group">
              <input type="color" id="newTagColor" class="modal-input" value="#FFD700">
            </div>
            <!-- Puedes agregar un textarea para la descripción si lo deseas -->
            <button type="submit" class="modal-submit">Agregar Etiqueta</button>
          </form>

          <div class="available-tags">
            <h4>Etiquetas Disponibles</h4>
            <div id="availableTagsList" class="tags-list"></div>
          </div>
        </div>
        <div class="tag-section">
          <h3>Etiquetas Asignadas</h3>
          <div id="assignedTagsList" class="tags-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Crear usuario -->
  <div id="addUserModal" class="fixed inset-0 z-[1000] items-center justify-center bg-black/50 p-4" style="display:none">
    <div class="w-full max-w-2xl rounded-2xl bg-white shadow-2xl" style="max-height:90vh; display:flex; flex-direction:column">
      <!-- Header -->
      <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4" style="flex-shrink:0">
        <h2 class="text-xl font-bold text-gray-800">👤 Crear Nuevo Usuario</h2>
        <button onclick="document.getElementById('addUserModal').style.display='none'" class="rounded-lg p-2 text-gray-400 transition hover:bg-gray-100 hover:text-gray-600">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Body -->
      <div class="overflow-y-auto px-6 py-4" style="flex:1">
        <div class="space-y-4">
          <!-- Nombre Completo -->
          <div>
            <label class="mb-1 block text-sm font-medium text-gray-700">Nombre Completo *</label>
            <input type="text" id="newNombreCompleto" placeholder="Ej: Juan Pérez García" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-200">
          </div>

          <!-- Nombre de Usuario -->
          <div>
            <label class="mb-1 block text-sm font-medium text-gray-700">Nombre de Usuario *</label>
            <input type="text" id="newUsername" placeholder="Ej: jperez" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-200">
            <p class="mt-1 text-xs text-gray-500">Sin espacios, minúsculas</p>
          </div>

          <!-- Email -->
          <div>
            <label class="mb-1 block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="newEmail" placeholder="correo@ejemplo.com" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-200">
          </div>

          <!-- WhatsApp -->
          <div>
            <label class="mb-1 block text-sm font-medium text-gray-700">Número de WhatsApp</label>
            <input type="tel" id="newWhatsapp" placeholder="521234567890" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-200">
            <p class="mt-1 text-xs text-gray-500">Formato: código país + número (Ej: 521234567890)</p>
          </div>

          <!-- Tipo de Usuario -->
          <div>
            <label class="mb-1 block text-sm font-medium text-gray-700">Tipo de Usuario *</label>
            <select id="userType" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-200">
              <option value="operador">Operador (Vendedor)</option>
              <option value="admin">Administrador</option>
            </select>
          </div>

          <!-- Contraseña -->
          <div>
            <label class="mb-1 block text-sm font-medium text-gray-700">Contraseña *</label>
            <input type="password" id="newPassword" placeholder="Mínimo 6 caracteres" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-200">
            <p class="mt-1 text-xs text-gray-500">Mínimo 6 caracteres</p>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="flex justify-end gap-3 border-t border-gray-200 px-6 py-4" style="flex-shrink:0">
        <button type="button" onclick="document.getElementById('addUserModal').style.display='none'" class="rounded-lg border border-gray-300 px-4 py-2 font-medium text-gray-700 hover:bg-gray-50">
          Cancelar
        </button>
        <button type="button" onclick="createUser()" class="rounded-lg bg-purple-600 px-4 py-2 font-medium text-white hover:bg-purple-700">
          <svg class="mr-2 inline-block h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Crear Usuario
        </button>
      </div>
    </div>
  </div>

  <!-- Mensaje masivo -->
  <div id="bulkMessageModal" class="modal">
    <div class="modal-content bulk-message-modal">
      <span class="close">&times;</span>
      <div id="bulkMessageContainer"></div>
    </div>
  </div>

  <!-- QR WhatsApp -->
  <div id="qrModal" class="modal">
    <div class="modal-content">
      <div class="qr-header">
        <h2>Escanea el código QR</h2>
        <p>Para conectar WhatsApp, sigue estos pasos:</p>
      </div>
      <div class="qr-container" id="qrContainer">
        <!-- El QR se mostrará aquí -->
      </div>
      <div class="qr-instructions">
        <ol>
          <li>Abre WhatsApp en tu teléfono</li>
          <li>Toca Menú o Configuración y selecciona WhatsApp Web</li>
          <li>Apunta tu teléfono hacia esta pantalla para escanear el código QR</li>
        </ol>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>

  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
      position: relative;
    }

    .qr-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .qr-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 8px;
    }

    .qr-container img {
      max-width: 256px;
      height: auto;
    }

    .qr-instructions {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .qr-instructions ol {
      margin: 0;
      padding-left: 20px;
    }

    .qr-instructions li {
      margin: 10px 0;
    }
  </style>
  <!-- En el orden correcto, antes de cerrar el body -->
  <!-- Añadir antes de cerrar el body, junto con los otros scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="/js/socket.js"></script>
  <script src="/js/BulkMessageSender.js"></script>
  <script src="/js/NewChatButton.js"></script>
  <script src="/js/tags.js"></script>


  <script>
    /***************************************************************
     * 1. Variables globales y estado
     ***************************************************************/
    let socket;
    let isConnecting = false;
    let typingTimeout = null;
    let scheduleModal = null;
    let noteModal = null;
    let currentTags = [];
    let isMessageInProgress = false;
    let currentQRTimeout = null;
    let isQRModalOpen = false;

    const ChatState = {
      currentPhoneNumber: null,
      isLoading: false,
      lastUpdate: null,
      updateInProgress: false
    };

    const processedMessages = new Set();
    const MESSAGE_HISTORY_LIMIT = 1000;
    const unreadCounts = {};
    window.currentPhoneNumber = null; // Definición global

    /***************************************************************
     * 2. Manejo de mensajes entrantes (handleNewMessage, etc.)
     ***************************************************************/
    window.handleNewMessage = function (msg) {
      try {
        // Generar un ID para evitar duplicados
        const messageId = `${msg.phoneNumber}-${msg.timestamp}-${msg.message}`;

        // Evitar duplicados
        if (processedMessages.has(messageId)) return;
        processedMessages.add(messageId);

        // Limpiar el Set si se acumula demasiado
        if (processedMessages.size > MESSAGE_HISTORY_LIMIT) {
          const itemsToDelete = Array.from(processedMessages).slice(0, 100);
          itemsToDelete.forEach(item => processedMessages.delete(item));
        }

        console.log('Nuevo mensaje recibido:', msg);

        // Solo renderizar en pantalla si es el chat abierto
        if (msg.phoneNumber === currentPhoneNumber) {
          renderMessage(msg);
          const container = document.getElementById('messagesContainer');
          if (container) container.scrollTop = container.scrollHeight;
        }

        // Actualizar la lista de chats
        loadChatList();

      } catch (error) {
        console.error('Error al manejar nuevo mensaje:', error);
      }
    };

    window.handleUserTyping = function (data) {
      try {
        if (data.phoneNumber === currentPhoneNumber) {
          const typingIndicator = document.querySelector('.typing-indicator');
          if (typingIndicator) {
            typingIndicator.classList.add('active');
            setTimeout(() => {
              typingIndicator.classList.remove('active');
            }, 3000);
          }
        }
      } catch (error) {
        console.error('Error al manejar typing:', error);
      }
    };

    window.handleUserStoppedTyping = function (data) {
      try {
        if (data.phoneNumber === window.currentPhoneNumber) {
          const typingIndicator = document.querySelector('.typing-indicator');
          if (typingIndicator) typingIndicator.classList.remove('active');
        }
      } catch (error) {
        console.error('Error al manejar stop typing:', error);
      }
    };

    function handleTypingEvent() {
      if (!window.currentPhoneNumber) return;

      if (typingTimeout) {
        clearTimeout(typingTimeout);
      }

      socket.emit('typing', { phoneNumber: window.currentPhoneNumber });
      typingTimeout = setTimeout(() => {
        socket.emit('stopTyping', { phoneNumber: window.currentPhoneNumber });
      }, 1000);
    }

    /***************************************************************
     * 3. Autenticación y helpers
     ***************************************************************/
    function checkAuth() {
      const token = sessionStorage.getItem('token');
      if (!token) {
        sessionStorage.clear();
        window.location.href = '/login';
        return false;
      }

      // Verificar si el token está expirado
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const expirationTime = payload.exp * 1000; // Convertir a milisegundos
        const currentTime = Date.now();

        if (currentTime >= expirationTime) {
          console.log('Token expirado, redirigiendo a login...');
          sessionStorage.clear();
          window.location.href = '/login';
          return false;
        }
      } catch (error) {
        console.error('Error al verificar el token:', error);
        sessionStorage.clear();
        window.location.href = '/login';
        return false;
      }

      return true;
    }

    async function fetchWithAuth(url, options = {}) {
      const token = sessionStorage.getItem('token');
      if (!token) {
        window.location.href = '/login';
        return null;
      }

      const defaultHeaders = {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      };

      const response = await fetch(url, {
        ...options,
        headers: {
          ...defaultHeaders,
          ...(options.headers || {})
        }
      });

      if (response.status === 401) {
        sessionStorage.clear();
        window.location.href = '/login';
        return null;
      }
      return response;
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message) {
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.textContent = message;
      const container = document.getElementById('messagesContainer') || document.body;
      container.appendChild(successDiv);

      setTimeout(() => successDiv.remove(), 3000);
    }

    function formatPhoneNumber(phone) {
      if (!phone) return 'Número desconocido';
      const cleaned = phone.toString().replace(/\D/g, '');
      if (cleaned.length === 12) {
        return cleaned.replace(/(\d{2})(\d{2})(\d{4})(\d{4})/, '$1 $2 $3 $4');
      }
      if (cleaned.length === 10) {
        return cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '$1 $2 $3');
      }
      return phone;
    }

    function formatToSpecificTimeZone(timestamp) {
      try {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) return '';
        return date.toLocaleString('es-MX', {
          hour: '2-digit',
          minute: '2-digit',
          hour12: true,
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      } catch (error) {
        console.error('Error formatting timestamp:', error);
        return '';
      }
    }

    /***************************************************************
     * 4. EventListeners y setup
     ***************************************************************/
    function initEventListeners() {
      console.log('Inicializando event listeners...');

      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          filterChats(e.target.value);
        });
      }

      const messageInput = document.getElementById('messageInput');
      if (messageInput) {
        messageInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            const button = document.getElementById('sendButton');
            if (button) button.click();
          }
        });
      }

      // Cerrar emoji picker al hacer click fuera
      document.addEventListener('click', (e) => {
        const picker = document.getElementById('emojiPicker');
        if (picker && !e.target.closest('.emoji-picker') && !e.target.matches('#emojiButton')) {
          picker.style.display = 'none';
        }
      });

      // Cerrar modales al hacer click fuera
      document.addEventListener('click', (e) => {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        });
      });

      console.log('Event listeners inicializados');
    }

    function cleanupEventListeners() {
      if (typingTimeout) clearTimeout(typingTimeout);
    }

    /***************************************************************
     * 5. Botón nuevo chat (React)
     ***************************************************************/
    function initNewChatButton() {
      const container = document.getElementById('newChatButtonContainer');
      if (!container) {
        console.error('No se encontró el contenedor del botón nuevo chat');
        return;
      }
      if (!window.React || !window.ReactDOM || !window.NewChatButton) {
        console.error('No se encontraron dependencias para el botón nuevo chat');
        return;
      }
      try {
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(window.NewChatButton));
        console.log('Botón nuevo chat inicializado correctamente');
      } catch (error) {
        console.error('Error al inicializar el botón nuevo chat:', error);
      }
    }

    /***************************************************************
     * 6. Funciones Asistente (checkAssistantStatus, etc.)
     ***************************************************************/
    async function checkAssistantStatus(phoneNumber, button) {
      try {
        const response = await fetchWithAuth(`/assistant-status/${phoneNumber}`);
        const data = await response.json();
        updateAssistantButton(button, data.active);
        button.dataset.active = data.active ? 'true' : 'false';
      } catch (error) {
        console.error('Error al verificar estado del asistente:', error);
        const previousState = button.dataset.active === 'true';
        updateAssistantButton(button, previousState);
      }
    }

    async function updateAssistantButton(button, isActive) {
      button.innerHTML = '';
      button.dataset.active = isActive ? 'true' : 'false';

      const robotIcon = document.createElement('span');
      robotIcon.className = 'robot-icon';
      robotIcon.textContent = '🤖';

      const switchLabel = document.createElement('span');
      switchLabel.className = 'switch-label';
      switchLabel.textContent = 'Asistente';

      const switchContainer = document.createElement('div');
      switchContainer.className = 'switch-container';

      const switchElement = document.createElement('div');
      switchElement.className = 'switch';

      button.classList.toggle('active', isActive);

      switchContainer.appendChild(switchLabel);
      switchContainer.appendChild(switchElement);
      button.appendChild(robotIcon);
      button.appendChild(switchContainer);
    }

    async function toggleAssistant(phoneNumber) {
      try {
        const button = document.querySelector('.assistant-toggle');
        if (!button) return;
        button.disabled = true;

        const response = await fetchWithAuth('/toggle-assistant', {
          method: 'POST',
          body: JSON.stringify({ numeroTelefono: phoneNumber })
        });

        const data = await response.json();
        if (data.success) {
          updateAssistantButton(button, data.active);
          const message = data.active
            ? 'Asistente activado correctamente'
            : 'Asistente desactivado correctamente';

          const successDiv = document.createElement('div');
          successDiv.className = 'success-message';
          successDiv.textContent = message;
          document.getElementById('messagesContainer').appendChild(successDiv);
          setTimeout(() => successDiv.remove(), 3000);
        } else {
          showError(data.message || 'Error al cambiar estado del asistente');
        }
      } catch (error) {
        console.error('Error al cambiar estado del asistente:', error);
        showError('Error al cambiar estado del asistente');
      } finally {
        const button = document.querySelector('.assistant-toggle');
        if (button) button.disabled = false;
      }
    }

    /***************************************************************
     * 7. Funciones de EMOJI (picker)
     ***************************************************************/
    function initEmojiPicker() {
      const emojis = [
        '😊', '😂', '❤️', '👍', '😅', '😎',
        '🎉', '👋', '😔', '🤔', '😉', '🙌',
        '🤗', '😴', '😍', '🤣'
      ];
      const grid = document.getElementById('emojiGrid');
      emojis.forEach(emoji => {
        const span = document.createElement('span');
        span.className = 'emoji-item';
        span.textContent = emoji;
        span.onclick = () => insertEmoji(emoji);
        grid.appendChild(span);
      });
    }

    function toggleEmojiPicker() {
      const picker = document.getElementById('emojiPicker');
      picker.style.display = (picker.style.display === 'none') ? 'block' : 'none';
    }

    function insertEmoji(emoji) {
      const input = document.getElementById('messageInput');
      input.value += emoji;
      input.focus();
    }

    /***************************************************************
     * 8. loadChatList (versión centralizada)
     ***************************************************************/
    async function loadChatList(force = false) {
      console.log('🔍 Cargando lista de chats. Forzar:', force);

      const MAX_LOAD_TIME = 10000;
      const token = sessionStorage.getItem('token');
      if (!token) {
        console.error('❌ No hay token de autenticación');
        window.location.href = '/login';
        return;
      }

      // Evitar llamadas simultáneas
      if (ChatState.updateInProgress && !force) {
        console.log('⏳ Actualización en progreso, saltando...');
        return;
      }
      ChatState.updateInProgress = true;

      const chatListSpinner = document.getElementById('chatListSpinner');
      if (chatListSpinner) { chatListSpinner.style.display = 'block'; }

      try {
        console.log('🚀 Iniciando carga de lista de chats');

        const response = await fetch('/chat-list', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          signal: AbortSignal.timeout(MAX_LOAD_TIME)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Error HTTP ${response.status}: ${errorText}`);
        }

        const chats = await response.json();

        // Contenedor principal: .chat-items
        const chatList = document.querySelector('.chat-items');
        if (!chatList) {
          throw new Error('No se encontró el contenedor .chat-items en el DOM');
        }

        // Limpiar el contenedor
        chatList.innerHTML = '';

        if (chats && chats.length > 0) {
          for (const chat of chats) {
            try {
              const chatItem = await createChatListItem(chat);
              if (chatItem) {
                chatList.appendChild(chatItem);
              }
            } catch (itemError) {
              console.error(`Error procesando chat ${chat.numero_telefono}:`, itemError);
            }
          }
        } else {
          const noChats = document.createElement('div');
          noChats.className = 'no-chats';
          noChats.textContent = 'No hay chats disponibles';
          chatList.appendChild(noChats);
        }

        // Ordenar por timestamp
        sortChatItemsByTimestamp();

        ChatState.lastUpdate = Date.now();
        console.log(`✅ Lista de chats actualizada. Total: ${chats?.length || 0} chats`);

        // Si la vista de tabla está activa
        const tableView = document.getElementById('tableView');
        if (tableView && tableView.style.display === 'block') {
          await loadTableView();
        }

      } catch (error) {
        console.error('❌ Error al cargar lista de chats:', error);

        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = 'No se pudo cargar la lista de chats. Por favor, intenta de nuevo.';
        const chatItems = document.querySelector('.chat-items');
        if (chatItems) {
          chatItems.innerHTML = '';
          chatItems.appendChild(errorDiv);
        }

        if (error.name === 'AbortError') {
          console.warn('⏰ Tiempo de carga excedido');
        }
        if (error.status === 401) {
          window.location.href = '/login';
        }

      } finally {
        ChatState.updateInProgress = false;
        if (chatListSpinner) { chatListSpinner.style.display = 'none'; }
      }
    }

    /***************************************************************
        * JS: función para pintar etiquetas y llamada desde createChatListItem
        ***************************************************************/
    async function renderTagsForChatItem(phoneNumber, container) {
      try {
        if (!container) return;
        const token = sessionStorage.getItem('token');
        const res = await fetch(`/api/chat/etiquetas/${encodeURIComponent(phoneNumber)}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) return;

        const etiquetas = await res.json();
        container.innerHTML = '';

        (etiquetas || [])
          .filter(e => e.activo)
          .sort((a, b) => (a.prioridad || 0) - (b.prioridad || 0))
          .slice(0, 4)
          .forEach(e => {
            const badge = document.createElement('span');
            badge.className = 'chat-list-tag';
            const bg = e.color || e.color_hex || '#6b7280';  // << usa color si existe
            badge.style.backgroundColor = bg;
            badge.textContent = e.nombre || 'Etiqueta';
            container.appendChild(badge);
          });
      } catch (err) {
        console.warn('No se pudieron cargar etiquetas para', phoneNumber, err);
      }
    }


    /***************************************************************
     * 9. Creación del ítem de chat y funciones asociadas
     ***************************************************************/
    async function createChatListItem(chat) {
      if (!chat || !chat.numero_telefono) {
        console.error('Invalid chat data:', chat);
        return null;
      }

      const chatItem = document.createElement('div');
      chatItem.className = 'chat-list-item';
      chatItem.dataset.phoneNumber = chat.numero_telefono;
      chatItem.dataset.lastMessageTime = String(chat.ultima_actividad || Date.now());

      // Info principal (izquierda)
      const chatInfo = document.createElement('div');
      chatInfo.className = 'chat-info';

      const chatPhoneEl = document.createElement('div');
      chatPhoneEl.className = 'chat-phone';
      chatPhoneEl.textContent = chat.nombre_contacto || formatPhoneNumber(chat.numero_telefono);

      const chatPreviewEl = document.createElement('div');
      chatPreviewEl.className = 'chat-preview';
      chatPreviewEl.textContent = chat.ultimo_mensaje || 'Sin mensajes';

      chatInfo.appendChild(chatPhoneEl);
      chatInfo.appendChild(chatPreviewEl);

      // Contenedor de etiquetas (derecha)
      const tagsContainer = document.createElement('div');
      tagsContainer.className = 'chat-list-tag-container';

      // Orden correcto: primero info, luego tags (tags se irán a la derecha)
      chatItem.appendChild(chatInfo);
      chatItem.appendChild(tagsContainer);

      // Render de etiquetas activas
      renderTagsForChatItem(chat.numero_telefono, tagsContainer);

      // Badge de no leídos
      let unreadCount = typeof chat.unread_count !== 'undefined'
        ? chat.unread_count
        : (unreadCounts[chat.numero_telefono] || 0);

      if (unreadCount > 0) {
        const badge = document.createElement('div');
        badge.className = 'new-message-badge';
        badge.textContent = unreadCount;
        chatItem.appendChild(badge);
      }

      // Click para abrir chat
      chatItem.onclick = async () => {
        window.currentPhoneNumber = chat.numero_telefono;
        await markChatAsRead(chat.numero_telefono);

        const badge = chatItem.querySelector('.new-message-badge');
        if (badge) {
          badge.classList.add('fade-out');
          setTimeout(() => badge.remove(), 300);
        }
        await loadChat(chat.numero_telefono);
      };

      return chatItem;
    }


    function sortChatItemsByTimestamp() {
      const container = document.querySelector('.chat-items');
      if (!container) return;

      const items = Array.from(container.querySelectorAll('.chat-list-item'));
      items.sort((a, b) => {
        const tA = Number(a.dataset.lastMessageTime || 0);
        const tB = Number(b.dataset.lastMessageTime || 0);
        return tB - tA;
      });
      items.forEach(item => container.appendChild(item));
    }

    function filterChats(query) {
      console.log('Filtrando chats con query:', query);
      const items = document.getElementsByClassName('chat-list-item');
      const searchTerm = query.toLowerCase();

      Array.from(items).forEach(item => {
        const text = item.textContent.toLowerCase();
        const shouldShow = text.includes(searchTerm);
        item.style.display = shouldShow ? '' : 'none';
      });
    }

    /***************************************************************
     * 10. Cargar y renderizar un chat
     ***************************************************************/
    async function markChatAsRead(phoneNumber) {
      const token = sessionStorage.getItem('token');
      if (!token) { window.location.href = '/login'; return; }
      try {
        const response = await fetch(`/mark-as-read/${phoneNumber}`, {
          method: 'POST',
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!response.ok) { throw new Error('Error al marcar mensajes como leídos'); }
        console.log(`Chat ${phoneNumber} marcado como leído`);
      } catch (error) {
        console.error('Error en markChatAsRead:', error);
      }
    }

    async function fetchIsBlocked(phoneNumber) {
      const token = sessionStorage.getItem('token');
      const response = await fetch(`/block-number/${phoneNumber}`, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!response.ok) {
        console.error('Error verificando bloqueo:', await response.text());
        return false;
      }
      const data = await response.json();
      return data.blocked;
    }

    async function loadChat(phoneNumber) {
      if (!checkAuth()) return;

      try {
        console.log('=== INICIO CARGA DE CHAT ===');
        console.log('Intentando cargar chat para:', phoneNumber);

        if (!phoneNumber) { throw new Error('No se proporcionó número de teléfono'); }

        window.currentPhoneNumber = phoneNumber;
        await markChatAsRead(phoneNumber);

        const header = document.getElementById('chatHeader');
        if (!header) { throw new Error('No se encontró el elemento header'); }
        header.innerHTML = '';

        // --- HEADER CONTENT (título + tags + menú) ---
        const headerContent = document.createElement('div');
        headerContent.className = 'header-content';

        // Nombre por defecto: teléfono formateado
        let contactName = formatPhoneNumber(phoneNumber);

        try {
          const contactRes = await fetchWithAuth(`/contacts/${phoneNumber}`);
          if (contactRes.ok) {
            const contactData = await contactRes.json();
            if (contactData && contactData.data && contactData.data.nombre) {
              contactName = contactData.data.nombre;
            }
          }
        } catch (err) {
          console.error('Error obteniendo el nombre de contacto:', err);
        }

        const nameEl = document.createElement('span');
        nameEl.className = 'header-title';
        nameEl.textContent = contactName;

        const phoneEl = document.createElement('span');
        phoneEl.className = 'header-phone';
        phoneEl.textContent = formatPhoneNumber(phoneNumber);

        const titleGroup = document.createElement('div');
        titleGroup.style.display = 'inline-flex';
        titleGroup.style.alignItems = 'center';
        titleGroup.style.gap = '8px';
        titleGroup.appendChild(nameEl);
        titleGroup.appendChild(phoneEl);

        headerContent.appendChild(titleGroup);
        header.appendChild(headerContent);

        // Renombrar contacto por doble clic
        nameEl.addEventListener('dblclick', () => {
          handleContactNameDblClick(nameEl, phoneNumber, contactName);
        });

        // Estado bloqueado
        const isBlocked = await fetchIsBlocked(phoneNumber);
        if (isBlocked) { nameEl.textContent = (contactName || formatPhoneNumber(phoneNumber)) + ' (Bloqueado)'; }

        // TAGS
        const tagsContainer = document.createElement('div');
        tagsContainer.className = 'chat-tags';
        headerContent.appendChild(tagsContainer);

        try {
          const token = sessionStorage.getItem('token');
          if (!token) { throw new Error('No hay token de autenticación'); }

          const tagsResponse = await fetch(`/api/chat/etiquetas/${phoneNumber}`, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (tagsResponse.ok) {
            const tags = await tagsResponse.json();
            if (tags && tags.length > 0) {
              const assignedTags = tags
                .filter(tag => tag.activo)
                .sort((a, b) => (a.prioridad || 0) - (b.prioridad || 0));
              assignedTags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag';
                tagElement.style.backgroundColor = tag.color;
                tagElement.textContent = tag.nombre;
                tagsContainer.appendChild(tagElement);
              });
            }
          }
        } catch (error) {
          console.error('Error al cargar etiquetas:', error);
        }

        // ——— Menú desplegable ———
        // SIEMPRE anclar dentro de headerContent (no directo al header)
        let menuContainer = headerContent.querySelector('.menu-container');
        let menuButton = headerContent.querySelector('.menu-button');
        let dropdownMenu = headerContent.querySelector('.dropdown-menu');

        if (!menuContainer) {
          menuContainer = document.createElement('div');
          menuContainer.className = 'menu-container';
          headerContent.appendChild(menuContainer);
        }

        if (!menuButton) {
          menuButton = document.createElement('button');
          menuButton.className = 'menu-button';
          menuButton.innerHTML = '⋮';
          menuContainer.appendChild(menuButton);
        }

        if (!dropdownMenu) {
          dropdownMenu = document.createElement('div');
          dropdownMenu.className = 'dropdown-menu';
          menuContainer.appendChild(dropdownMenu);
        }

        // Limpia items dinámicos previos para no duplicar (solo los que marcamos)
        dropdownMenu.querySelectorAll('[data-dyn-item="true"]').forEach(n => n.remove());

        const userType = sessionStorage.getItem('userType');
        console.log('Tipo de usuario actual:', userType);

        // Asignar chat
        const assignButton = document.createElement('button');
        assignButton.className = 'dropdown-item';
        assignButton.textContent = 'Asignar Chat';
        assignButton.onclick = async (e) => {
          e.stopPropagation();
          try {
            assignButton.disabled = true;
            await toggleChatAssignment(phoneNumber);
            await checkChatAssignment(phoneNumber, assignButton);
          } catch (error) {
            console.error('Error en asignación:', error);
            showError('Error al cambiar la asignación del chat');
          } finally {
            assignButton.disabled = false;
          }
        };
        dropdownMenu.appendChild(assignButton);

        // Bloquear / Desbloquear
        const blockButton = document.createElement('button');
        blockButton.className = 'dropdown-item';
        blockButton.textContent = isBlocked ? 'Desbloquear Chat' : 'Bloquear Chat';
        blockButton.onclick = async (e) => {
          e.stopPropagation();
          await toggleBlockNumber(phoneNumber, isBlocked);
          const newIsBlocked = await fetchIsBlocked(phoneNumber);
          blockButton.textContent = newIsBlocked ? 'Desbloquear Chat' : 'Bloquear Chat';
          const baseName = contactName || formatPhoneNumber(phoneNumber);
          nameEl.textContent = baseName + (newIsBlocked ? ' (Bloqueado)' : '');
        };
        dropdownMenu.appendChild(blockButton);

        // Asistente
        const assistantButton = document.createElement('button');
        assistantButton.className = 'dropdown-item assistant-toggle';
        assistantButton.onclick = (e) => { e.stopPropagation(); toggleAssistant(phoneNumber); };
        dropdownMenu.appendChild(assistantButton);

        if (typeof checkAssistantStatus === 'function') {
          await checkAssistantStatus(phoneNumber, assistantButton);
        } else {
          console.error('checkAssistantStatus no está definida');
          assistantButton.textContent = '🤖 Activar Asistente';
          assistantButton.classList.remove('active');
        }

        // Etiquetas
        const tagsButton = document.createElement('button');
        tagsButton.textContent = 'Gestionar Etiquetas';
        tagsButton.className = 'dropdown-item';
        tagsButton.onclick = (e) => {
          e.stopPropagation();
          console.log('Click en gestionar etiquetas para:', phoneNumber);
          toggleTagModal();
        };
        dropdownMenu.appendChild(tagsButton);

        // Admin y Gerente tienen acceso a opciones avanzadas
        if (userType === 'admin' || userType === 'gerente') {
          const addUserButton = document.createElement('button');
          addUserButton.textContent = 'Agregar Usuario';
          addUserButton.className = 'dropdown-item';
          addUserButton.onclick = (e) => { e.stopPropagation(); toggleAddUserModal(); };
          dropdownMenu.appendChild(addUserButton);

          const deleteChatButton = document.createElement('button');
          deleteChatButton.className = 'dropdown-item';
          deleteChatButton.textContent = 'Borrar Chat';
          deleteChatButton.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = confirm('¿Estás seguro de que quieres eliminar todos los mensajes de este chat?');
            if (!confirmed) return;
            await deleteChat(phoneNumber);
            await loadChatList(true);
            const container = document.getElementById('messagesContainer');
            if (container) container.innerHTML = '';
          };
          dropdownMenu.appendChild(deleteChatButton);

          const bulkMessageButton = document.createElement('button');
          bulkMessageButton.className = 'dropdown-item';
          bulkMessageButton.innerHTML = 'Mensaje Masivo';
          bulkMessageButton.onclick = (e) => {
            e.stopPropagation();
            const modal = document.getElementById('bulkMessageModal');
            if (modal) { modal.style.display = 'block'; }
          };
          dropdownMenu.appendChild(bulkMessageButton);
        }

        // --- Nueva reserva ---
        const nuevaReservaBtn = document.createElement('button');
        nuevaReservaBtn.className = 'dropdown-item';
        nuevaReservaBtn.setAttribute('data-dyn-item', 'true');
        nuevaReservaBtn.innerHTML = '🆕 Nueva reserva';
        nuevaReservaBtn.onclick = (e) => {
          e.stopPropagation();
          onNuevaReservaClick();
          dropdownMenu.style.display = 'none';
        };
        dropdownMenu.appendChild(nuevaReservaBtn);

        // --- Pagos ---
        const pagosBtn = document.createElement('button');
        pagosBtn.className = 'dropdown-item';
        pagosBtn.setAttribute('data-dyn-item', 'true');
        pagosBtn.innerHTML = '💳 Pagos';
        pagosBtn.onclick = (e) => {
          e.stopPropagation();
          onPagosClick();
          dropdownMenu.style.display = 'none';
        };
        dropdownMenu.appendChild(pagosBtn);

        // --- Conexión WhatsApp (solo gerentes) ---
        if (userType === 'gerente') {
          const whatsappBtn = document.createElement('button');
          whatsappBtn.textContent = '📱 Conexión WhatsApp';
          whatsappBtn.className = 'dropdown-item';
          whatsappBtn.style.cssText = 'background: #25D366; color: white; font-weight: 600;';
          whatsappBtn.onclick = (e) => {
            e.stopPropagation();
            window.location.href = '/whatsapp-connection';
            dropdownMenu.style.display = 'none';
          };
          dropdownMenu.appendChild(whatsappBtn);
        }

        // Cerrar Sesión
        const logoutButton = document.createElement('button');
        logoutButton.textContent = 'Cerrar Sesión';
        logoutButton.className = 'dropdown-item';
        logoutButton.onclick = (e) => {
          e.stopPropagation();
          sessionStorage.clear();
          window.location.href = '/login';
        };
        dropdownMenu.appendChild(logoutButton);

        // Toggle del menú (SOLO una vez)
        menuButton.onclick = (e) => {
          e.stopPropagation();
          dropdownMenu.style.display = (dropdownMenu.style.display === 'block') ? 'none' : 'block';
        };

        if (!window.menuCloseListener) {
          window.menuCloseListener = true;
          document.addEventListener('click', () => {
            const menus = document.querySelectorAll('.dropdown-menu');
            menus.forEach(menu => menu.style.display = 'none');
          });
        }

        // Estado de asignación
        await checkChatAssignment(phoneNumber, assignButton);

        // Habilitar controles de envío
        const controls = ['messageInput', 'sendButton', 'scheduleButton', 'noteButton', 'uploadButton'];
        controls.forEach(id => {
          const element = document.getElementById(id);
          if (element) element.disabled = false;
        });

        // Acceso al chat
        const token = sessionStorage.getItem('token');
        if (!token) { window.location.href = '/login'; return; }

        const accessResponse = await fetch(`/chat-access/${phoneNumber}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const accessData = await accessResponse.json();
        console.log('Datos de acceso:', accessData);

        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const scheduleButton = document.getElementById('scheduleButton');
        const noteButton = document.getElementById('noteButton');
        const uploadButton = document.getElementById('uploadButton');
        const aiButton = document.getElementById('aiButton');
        const inputContainer = document.querySelector('.message-input');

        if (!accessData.hasAccess) {
          [messageInput, sendButton, scheduleButton, noteButton, uploadButton, aiButton].forEach(el => { if (el) el.disabled = true; });
          if (messageInput) messageInput.value = 'Chat asignado a ' + accessData.assignedTo;
          if (inputContainer) inputContainer.style.backgroundColor = '#f5f5f5';
        } else {
          [messageInput, sendButton, scheduleButton, noteButton, uploadButton, aiButton].forEach(el => { if (el) el.disabled = false; });
          if (messageInput) {
            messageInput.value = '';
            messageInput.placeholder = 'Escribe un mensaje';
          }
          if (inputContainer) inputContainer.style.backgroundColor = 'white';
        }

        // Mensajes / notas / programados
        console.log('Cargando mensajes...');
        const container = document.getElementById('messagesContainer');
        if (!container) throw new Error('No se encontró el contenedor de mensajes');
        container.innerHTML = '';

        const [messagesResponse, scheduledResponse, notesResponse] = await Promise.all([
          fetch(`/messages/${phoneNumber}`, {
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
          }),
          fetch(`/scheduled-messages/${phoneNumber}`, {
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
          }),
          fetch(`/notes/${phoneNumber}`, {
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
          })
        ]);

        if (!messagesResponse.ok || !scheduledResponse.ok || !notesResponse.ok) {
          throw new Error('Error al cargar los mensajes');
        }

        const [messages, scheduled, notes] = await Promise.all([
          messagesResponse.json(),
          scheduledResponse.json(),
          notesResponse.json()
        ]);

        console.log('Mensajes cargados:', {
          mensajes: messages.length,
          programados: scheduled.length,
          notas: notes.length
        });

        if (messages?.length > 0) {
          messages
            .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
            .forEach(msg => {
              try { renderMessage(msg); }
              catch (error) { console.error('Error al renderizar mensaje:', error, msg); }
            });
        }

        if (notes?.length > 0) {
          notes.forEach(note => {
            try { renderNote(note); }
            catch (error) { console.error('Error al renderizar nota:', error, note); }
          });
        }

        if (scheduled?.length > 0) {
          try {
            container.appendChild(createScheduledSection(scheduled));
          } catch (error) {
            console.error('Error al renderizar mensajes programados:', error);
          }
        }

        container.scrollTop = container.scrollHeight;
        await fetchWithAuth(`/mark-as-read/${phoneNumber}`, { method: 'POST' });

        console.log('=== FIN CARGA DE CHAT ===');
        return true;
      } catch (error) {
        console.error('Error detallado en loadChat:', error);
        if (error.status === 401) { window.location.href = '/login'; }
        else { showError('Error al cargar el chat: ' + error.message); }
        return false;
      }
    }


    async function handleContactNameDblClick(headerTitleEl, phoneNumber, oldName) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = oldName || '';
      input.style.minWidth = '150px';
      headerTitleEl.textContent = '';
      headerTitleEl.appendChild(input);
      input.focus();
      input.select();

      const saveName = async () => {
        const newName = input.value.trim() || oldName;
        headerTitleEl.textContent = newName;
        if (newName !== oldName) {
          try {
            const resp = await fetchWithAuth(`/contacts/${phoneNumber}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ nombre: newName, isManual: true })
            });
            if (!resp.ok) {
              const data = await resp.json();
              throw new Error(data.message || 'Error al actualizar contacto');
            }
          } catch (error) {
            console.error('Error actualizando contacto:', error);
            headerTitleEl.textContent = oldName;
          }
        }
      };

      input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          await saveName();
        } else if (e.key === 'Escape') {
          headerTitleEl.textContent = oldName;
        }
      });

      input.addEventListener('blur', async () => {
        await saveName();
      });
    }

    /***************************************************************
     * 11. Manejo de notas, mensajes programados, etc.
     ***************************************************************/
    function renderNote(note) {
      const noteElement = document.createElement('div');
      noteElement.className = 'sent-message note-message';
      noteElement.dataset.noteId = note.id;

      const content = document.createElement('div');
      content.className = 'message-content';
      content.textContent = note.nota;

      const meta = document.createElement('div');
      meta.className = 'message-meta';
      meta.textContent = formatToSpecificTimeZone(note.fecha_creacion);

      const deleteButton = document.createElement('button');
      deleteButton.className = 'delete-note';
      deleteButton.innerHTML = '×';
      deleteButton.onclick = () => deleteNote(note.id);

      noteElement.appendChild(content);
      noteElement.appendChild(meta);
      noteElement.appendChild(deleteButton);

      const container = document.getElementById('messagesContainer');
      container.appendChild(noteElement);
      container.scrollTop = container.scrollHeight;
    }

    function createScheduledSection(scheduledMessages) {
      const section = document.createElement('div');
      section.className = 'scheduled-messages-container';

      const spacer = document.createElement('div');
      spacer.style.height = '20px';
      section.appendChild(spacer);

      const separator = document.createElement('div');
      separator.className = 'scheduled-section';
      separator.style.textAlign = 'center';
      separator.style.padding = '10px';
      separator.style.color = '#006bad';
      separator.style.fontSize = '12px';
      separator.style.fontWeight = 'bold';
      separator.style.backgroundColor = '#f0f8ff';
      separator.style.borderRadius = '10px';
      separator.style.margin = '0 10%';
      separator.textContent = 'Mensajes Programados';
      section.appendChild(separator);

      scheduledMessages
        .sort((a, b) => new Date(a.fecha_envio) - new Date(b.fecha_envio))
        .forEach(msg => renderScheduledMessage(msg, section));

      return section;
    }

    function renderScheduledMessage(msg, container = document.getElementById('messagesContainer')) {
      const messageElement = document.createElement('div');
      messageElement.className = 'sent-message scheduled-message';
      messageElement.dataset.scheduleId = msg.id;

      const content = document.createElement('div');
      content.className = 'message-content';
      content.textContent = msg.mensaje;

      const scheduledInfo = document.createElement('div');
      scheduledInfo.className = 'scheduled-info';
      const fechaProgramada = new Date(msg.fecha_envio);
      scheduledInfo.textContent = `Programado para: ${fechaProgramada.toLocaleDateString()} ${fechaProgramada.toLocaleTimeString()}`;

      const deleteButton = document.createElement('button');
      deleteButton.className = 'delete-scheduled';
      deleteButton.innerHTML = '×';
      deleteButton.onclick = () => deleteScheduledMessage(msg.id);

      messageElement.appendChild(content);
      messageElement.appendChild(scheduledInfo);
      messageElement.appendChild(deleteButton);

      container.appendChild(messageElement);
      return messageElement;
    }

    /***************************************************************
     * 12. Envío de mensajes, archivos, notas, etc.
     ***************************************************************/
    // Función para autoajustar la altura del textarea
    function autoResizeTextarea() {
      const textarea = document.getElementById('messageInput');
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
    }

    // Función para manejar el pegado de texto e imágenes
    document.addEventListener('DOMContentLoaded', function() {
      const textarea = document.getElementById('messageInput');

      // Autoajustar altura mientras escribe
      textarea.addEventListener('input', autoResizeTextarea);

      // Manejar Shift+Enter para nueva línea y Enter solo para enviar
      textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          if (e.shiftKey) {
            // Shift+Enter: permitir nueva línea (comportamiento por defecto)
            return;
          } else {
            // Enter solo: enviar mensaje
            e.preventDefault();
            sendMessage();
          }
        }
      });

      // Manejar pegado de texto e imágenes
      textarea.addEventListener('paste', async function(e) {
        const items = e.clipboardData.items;

        for (let i = 0; i < items.length; i++) {
          // Si es una imagen
          if (items[i].type.indexOf('image') !== -1) {
            e.preventDefault();
            const blob = items[i].getAsFile();

            // Crear un DataTransfer para simular selección de archivo
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(blob);

            const fileInput = document.getElementById('bulkFileInput');
            fileInput.files = dataTransfer.files;

            // Trigger el evento change para procesar la imagen
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);

            return;
          }
        }

        // Si es texto, preservar el formato (saltos de línea, etc.)
        // El navegador ya maneja esto correctamente con textarea
      });
    });

    // Función para mejorar texto con IA
    async function mejorarTextoConIA() {
      try {
        console.log('🤖 Iniciando mejora de texto con IA...');
        const textarea = document.getElementById('messageInput');
        const textoOriginal = textarea.value.trim();

        if (!textoOriginal) {
          console.log('❌ No hay texto para mejorar');
          showError('Escribe un mensaje primero para mejorarlo con IA ✨');
          return;
        }

        console.log('📝 Texto original:', textoOriginal);

        const aiButton = document.getElementById('aiButton');
        const textoBotonOriginal = aiButton.textContent;

        // Mostrar loading
        aiButton.textContent = '⏳';
        aiButton.disabled = true;

        const token = sessionStorage.getItem('token');
        console.log('🔑 Token obtenido:', token ? 'Sí' : 'No');

        console.log('📡 Enviando petición a /api/mejorar-texto...');
        const response = await fetch('/api/mejorar-texto', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ texto: textoOriginal })
        });

        console.log('📥 Respuesta recibida, status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('❌ Error HTTP:', response.status, errorText);
          throw new Error('Error al mejorar el texto: ' + response.status);
        }

        const data = await response.json();
        console.log('✅ Datos recibidos:', data);

        if (data.success && data.textoMejorado) {
          console.log('✨ Texto mejorado:', data.textoMejorado);
          textarea.value = data.textoMejorado;
          autoResizeTextarea();

          // Animación de éxito
          aiButton.textContent = '✅';
          setTimeout(() => {
            aiButton.textContent = textoBotonOriginal;
            aiButton.disabled = false;
          }, 1500);
        } else {
          throw new Error(data.message || 'No se pudo mejorar el texto');
        }

      } catch (error) {
        console.error('❌ Error al mejorar texto:', error);
        showError('Error al mejorar el texto con IA: ' + error.message);

        const aiButton = document.getElementById('aiButton');
        aiButton.textContent = '✨';
        aiButton.disabled = false;
      }
    }

    async function sendMessage() {
      try {
        if (isMessageInProgress) return;

        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        const token = sessionStorage.getItem('token');

        if (!message || !window.currentPhoneNumber) return;

        isMessageInProgress = true;

        const cleanNumber = window.currentPhoneNumber.replace(/\D/g, '');
        const formattedNumber = cleanNumber.length === 10
          ? `521${cleanNumber}`
          : cleanNumber.startsWith('521') ? cleanNumber
            : cleanNumber.startsWith('52') ? `521${cleanNumber.slice(2)}`
              : cleanNumber;

        const response = await fetch('/send-message', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            phoneNumber: formattedNumber,
            message: message,
            userId: sessionStorage.getItem('userId'),
            username: sessionStorage.getItem('username')
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Error al enviar el mensaje');
        }

        input.value = '';
      } catch (error) {
        console.error('Error al enviar mensaje:', error);
        showError('Error al enviar el mensaje: ' + error.message);
      } finally {
        setTimeout(() => {
          isMessageInProgress = false;
        }, 500);
      }
    }

    function renderMessage(msg) {
      console.log('Datos del mensaje a renderizar:', {
        tipo_contenido: msg.tipo_contenido,
        url_archivo: msg.url_archivo,
        mensaje: msg.message || msg.mensaje,
        sender_type: msg.sender_type
      });

      const messageElement = document.createElement('div');
      // Determinar si es "received" o "sent"
      messageElement.className = (msg.sender_type === 'received')
        ? 'received-message'
        : 'sent-message';

      // Información del usuario si procede (admin, operador, Asistente, etc.)
      if (
        msg.sender_type !== 'received' &&
        msg.nombre_usuario
      ) {
        const userInfo = document.createElement('div');
        userInfo.className = 'message-user-info';
        userInfo.textContent = msg.nombre_usuario;
        messageElement.appendChild(userInfo);
      }

      const contentContainer = document.createElement('div');
      contentContainer.className = 'message-content';

      if (msg.tipo_contenido) {
        // Mensaje multimedia
        const mediaContainer = document.createElement('div');
        mediaContainer.className = 'media-message';

        if (msg.tipo_contenido.startsWith('image')) {
          const img = document.createElement('img');
          img.src = msg.url_archivo;
          img.alt = 'Imagen compartida';
          img.style.maxWidth = '200px';
          img.style.maxHeight = '200px';
          img.style.cursor = 'pointer';
          img.onclick = () => window.open(msg.url_archivo, '_blank');
          mediaContainer.appendChild(img);

        } else if (msg.tipo_contenido.startsWith('video/')) {
          const video = document.createElement('video');
          video.src = msg.url_archivo;
          video.controls = true;
          video.style.maxWidth = '200px';
          mediaContainer.appendChild(video);

        } else if (msg.tipo_contenido.startsWith('audio')) {
          const audio = document.createElement('audio');
          audio.src = msg.url_archivo;
          audio.controls = true;
          audio.style.maxWidth = '200px';
          mediaContainer.appendChild(audio);

        } else {
          // Document u otros
          const fileLink = document.createElement('a');
          fileLink.href = msg.url_archivo;
          fileLink.target = '_blank';
          fileLink.className = 'file-attachment';
          fileLink.innerHTML = `
              <div class="file-icon">📎</div>
              <div class="file-info">
                <div class="file-name">${msg.nombre_archivo || 'Archivo'}</div>
                <div class="file-type">${msg.tipo_contenido}</div>
              </div>
            `;
          mediaContainer.appendChild(fileLink);
        }

        contentContainer.appendChild(mediaContainer);
      }

      if (msg.message || msg.mensaje) {
        // Texto o caption
        const textContent = document.createElement('div');
        textContent.className = 'text-content';
        textContent.textContent = msg.message || msg.mensaje;
        contentContainer.appendChild(textContent);
      }

      messageElement.appendChild(contentContainer);

      const meta = document.createElement('div');
      meta.className = 'message-meta';
      const time = formatToSpecificTimeZone(msg.timestamp || msg.fecha_hora || new Date());
      meta.textContent = (msg.sender_type === 'received')
        ? `Recibido ${time}`
        : time;
      messageElement.appendChild(meta);

      const container = document.getElementById('messagesContainer');
      if (!container) {
        console.warn('No existe #messagesContainer en el DOM');
        return;
      }
      container.appendChild(messageElement);
      container.scrollTop = container.scrollHeight;
    }

    async function handleFileUpload(event) {
      try {
        const file = event.target.files[0];
        if (!file) {
          showError('No se seleccionó ningún archivo');
          return;
        }

        const maxSize = 50 * 1024 * 1024;
        if (file.size > maxSize) {
          showError('El archivo excede el tamaño máximo permitido (50MB)');
          event.target.value = '';
          return;
        }

        const allowedTypes = [
          'image/jpeg',
          'image/png',
          'image/gif',
          'video/mp4',
          'application/pdf',
          'application/msword',
          'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
        ];

        if (!allowedTypes.includes(file.type)) {
          showError('Tipo de archivo no permitido');
          event.target.value = '';
          return;
        }

        window.currentFile = file;

        const previewModal = document.getElementById('filePreviewModal');
        const previewContainer = document.getElementById('filePreview');
        previewContainer.innerHTML = '';

        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'preview-image';
            previewContainer.appendChild(img);
            window.currentFileUrl = e.target.result;
          };
          reader.readAsDataURL(file);

        } else if (file.type.startsWith('video/')) {
          const video = document.createElement('video');
          video.controls = true;
          video.src = URL.createObjectURL(file);
          video.className = 'preview-video';
          previewContainer.appendChild(video);

        } else {
          const fileInfo = document.createElement('div');
          fileInfo.className = 'file-info-preview';
          fileInfo.innerHTML = `
              <div class="file-icon">📎</div>
              <div class="file-name">${file.name}</div>
              <div class="file-size">${formatFileSize(file.size)}</div>
            `;
          previewContainer.appendChild(fileInfo);
        }

        document.getElementById('fileCaption').value = '';
        previewModal.style.display = 'block';
        event.target.value = '';

      } catch (error) {
        console.error('Error en la vista previa del archivo:', error);
        showError('Error al procesar el archivo: ' + error.message);
        event.target.value = '';
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    async function sendFileWithCaption() {
      try {
        if (!window.currentFile || !window.currentPhoneNumber) {
          showError('No hay archivo para enviar o no se ha seleccionado un chat');
          return;
        }

        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading-state';
        loadingDiv.textContent = 'Enviando archivo...';
        document.getElementById('messagesContainer').appendChild(loadingDiv);

        const caption = document.getElementById('fileCaption').value.trim();
        const formData = new FormData();
        formData.append('file', window.currentFile);
        formData.append('phoneNumber', window.currentPhoneNumber);
        formData.append('caption', caption);

        const token = sessionStorage.getItem('token');
        if (!token) {
          throw new Error('No hay token de autenticación');
        }

        const uploadButton = document.getElementById('uploadButton');
        if (uploadButton) {
          uploadButton.disabled = true;
        }

        const response = await fetch('/upload-file', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        if (uploadButton) {
          uploadButton.disabled = false;
        }
        loadingDiv.remove();

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Error al enviar el archivo');
        }

        const result = await response.json();

        document.getElementById('filePreviewModal').style.display = 'none';
        document.getElementById('fileCaption').value = '';
        window.currentFile = null;
        window.currentFileUrl = null;

        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.textContent = 'Archivo enviado correctamente';
        const errorMessageElement = document.getElementById('errorMessage');
        if (errorMessageElement && errorMessageElement.parentNode) {
          errorMessageElement.parentNode.insertBefore(successDiv, errorMessageElement);
        }

        if (typeof loadChat === 'function' && window.currentPhoneNumber) {
          await loadChat(window.currentPhoneNumber);
        }

        setTimeout(() => {
          if (successDiv && successDiv.parentNode) {
            successDiv.remove();
          }
        }, 3000);

      } catch (error) {
        console.error('Error al enviar el archivo:', error);
        showError('Error al enviar el archivo: ' + error.message);

        const loadingDiv = document.querySelector('.loading-state');
        if (loadingDiv) loadingDiv.remove();

        const uploadButton = document.getElementById('uploadButton');
        if (uploadButton) {
          uploadButton.disabled = false;
        }
      }
    }

    async function saveNote() {
      try {
        const noteText = document.getElementById('noteText').value.trim();
        const token = sessionStorage.getItem('token');

        if (!noteText || !window.currentPhoneNumber) {
          showError('Por favor escribe una nota');
          return;
        }

        if (!token) {
          window.location.href = '/login';
          return;
        }

        const response = await fetch('/guardar-nota', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            numeroTelefono: window.currentPhoneNumber,
            nota: noteText
          })
        });

        const result = await response.json();

        if (!response.ok) {
          if (response.status === 401) {
            sessionStorage.clear();
            window.location.href = '/login';
            return;
          }
          throw new Error(result.message || 'Error al guardar la nota');
        }

        renderNote(result.data);

        document.getElementById('noteModal').style.display = 'none';
        document.getElementById('noteText').value = '';

        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.textContent = 'Nota guardada correctamente';
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.parentNode.insertBefore(successDiv, errorDiv);

        setTimeout(() => {
          successDiv.remove();
        }, 3000);

        await loadChat(window.currentPhoneNumber);

      } catch (error) {
        console.error('Error:', error);
        showError('Error al guardar la nota: ' + error.message);
      }
    }

    async function deleteNote(id) {
      try {
        const token = sessionStorage.getItem('token');
        if (!token) {
          window.location.href = '/login';
          return;
        }

        const response = await fetch(`/delete-note/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          if (response.status === 401) {
            sessionStorage.clear();
            window.location.href = '/login';
            return;
          }
          throw new Error('Error al eliminar la nota');
        }

        const noteElement = document.querySelector(`[data-note-id="${id}"]`);
        if (noteElement) {
          noteElement.remove();
        }

        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.textContent = 'Nota eliminada correctamente';
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.parentNode.insertBefore(successDiv, errorDiv);

        setTimeout(() => {
          successDiv.remove();
        }, 3000);

      } catch (error) {
        console.error('Error:', error);
        showError('Error al eliminar la nota');
      }
    }



    // ------- Abrir/cerrar modal de Reserva --------
    function toggleReservaModal(show = true) {
      const m = document.getElementById('reservaModal');
      if (!m) return;
      m.style.display = show ? 'block' : 'none';
    }

    // Si hay chat abierto, intentar prellenar el Contacto (si tu endpoint lo expone)
    async function prefillReservaModalFromCurrentChat() {
      const phone = window.currentPhoneNumber;
      if (!phone) return;
      try {
        const res = await fetchWithAuth(`/contacts/${phone}`);
        if (res && res.ok) {
          const data = await res.json();
          const cid = data?.data?.id || data?.id; // usa lo que te devuelva tu API
          if (cid) document.getElementById('reservaContactoId').value = cid;
        }
      } catch { }
    }

    async function onNuevaReservaClick() {
      await prefillReservaModalFromCurrentChat();
      toggleReservaModal(true);
    }

    function onPagosClick() {
      // Abre tu panel de pagos global (usa tu promos.html/PromosApp.js)
      // Si quieres pasar el teléfono actual: /promos?phone=...
      window.open('/promos', '_blank');
    }

    // ------- Crear reserva (usa tu API) --------
    async function submitReserva() {
      try {
        const token = sessionStorage.getItem('token');
        if (!token) { window.location.href = '/login'; return; }

        const contacto_id = parseInt(document.getElementById('reservaContactoId').value, 10);
        const destino = document.getElementById('reservaDestino').value.trim();
        const metodo = document.getElementById('reservaMetodo').value;

        const proveedor_id = parseInt(document.getElementById('reservaProv1').value, 10);
        const tipo = document.getElementById('reservaTipo1').value.trim();
        const precio_neto = parseFloat(document.getElementById('reservaNeto1').value);
        const precio_cliente = parseFloat(document.getElementById('reservaCliente1').value);

        if (!contacto_id || !destino || !proveedor_id || !tipo || !precio_neto || !precio_cliente) {
          showError('Completa todos los campos de la reserva');
          return;
        }

        const payload = {
          contacto_id,
          destino,
          metodo_cobro: metodo,        // el backend puede usar esto para calcular precio_proveedor
          items: [{
            proveedor_id,
            tipo,
            precio_neto,
            precio_cliente
            // precio_proveedor: opcional; usualmente lo calcula el backend según reglas
          }]
        };

        const resp = await fetchWithAuth('/reservas', {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const data = await resp.json();

        if (!resp.ok) throw new Error(data.message || 'Error al crear reserva');

        toggleReservaModal(false);
        showSuccess('Reserva creada correctamente');

        // Opcional: si el backend responde el id, puedes sugerir crear plan:
        // const rid = data.id || data.reserva?.id;
        // if (rid) { /* abrir pantalla de plan de pagos o dejar botón siguiente */ }

      } catch (err) {
        console.error(err);
        showError(err.message || 'Error al crear la reserva');
      }
    }


    /***************************************************************
     * 13. Programar mensajes
     ***************************************************************/
    function toggleScheduleMessage() {
      if (!scheduleModal) {
        scheduleModal = document.getElementById('scheduleModal');
      }

      if (scheduleModal) {
        scheduleModal.style.display = "block";
        document.getElementById('scheduledMessage').value =
          document.getElementById('messageInput').value;

        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);

        const dateStr = tomorrow.toISOString().split('T')[0];
        document.getElementById('scheduleDate').value = dateStr;

        const timeStr = now.toTimeString().slice(0, 5);
        document.getElementById('scheduleTime').value = timeStr;
      }
    }

    async function scheduleMessage() {
      try {
        const mensaje = document.getElementById('scheduledMessage').value;
        const fecha = document.getElementById('scheduleDate').value;
        const hora = document.getElementById('scheduleTime').value;
        const token = sessionStorage.getItem('token');

        if (!mensaje || !fecha || !hora) {
          showError('Por favor complete todos los campos');
          return;
        }

        if (!token) {
          window.location.href = '/login';
          return;
        }

        const fechaHora = new Date(`${fecha}T${hora}`);
        const response = await fetch('/programar-mensaje', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            numeroTelefono: window.currentPhoneNumber,
            mensaje: mensaje,
            fechaEnvio: fechaHora.toISOString()
          })
        });

        const data = await response.json();

        if (!response.ok) {
          if (response.status === 401) {
            sessionStorage.clear();
            window.location.href = '/login';
            return;
          }
          throw new Error(data.message || 'Error al programar el mensaje');
        }

        scheduleModal.style.display = "none";
        document.getElementById('scheduledMessage').value = '';
        document.getElementById('scheduleDate').value = '';
        document.getElementById('scheduleTime').value = '';

        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.textContent = 'Mensaje programado correctamente';
        successDiv.style.backgroundColor = '#d4edda';
        successDiv.style.color = '#155724';
        successDiv.style.padding = '10px';
        successDiv.style.margin = '10px';
        successDiv.style.borderRadius = '4px';
        successDiv.style.textAlign = 'center';

        const errorDiv = document.getElementById('errorMessage');
        errorDiv.parentNode.insertBefore(successDiv, errorDiv);

        setTimeout(() => {
          successDiv.remove();
        }, 3000);

        await loadChat(window.currentPhoneNumber);

      } catch (error) {
        console.error('Error:', error);
        showError('Error al programar el mensaje: ' + error.message);
      }
    }

    async function deleteScheduledMessage(id) {
      try {
        const token = sessionStorage.getItem('token');
        if (!token) {
          window.location.href = '/login';
          return;
        }

        const response = await fetch(`/delete-scheduled-message/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          if (response.status === 401) {
            sessionStorage.clear();
            window.location.href = '/login';
            return;
          }
          throw new Error('Error al eliminar el mensaje');
        }

        const messageElement = document.querySelector(`[data-schedule-id="${id}"]`);
        if (messageElement) {
          messageElement.remove();
        }

        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.textContent = 'Mensaje programado eliminado correctamente';
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.parentNode.insertBefore(successDiv, errorDiv);

        setTimeout(() => {
          successDiv.remove();
        }, 3000);

      } catch (error) {
        console.error('Error:', error);
        showError('Error al eliminar el mensaje programado');
      }
    }

    /***************************************************************
     * 14. Asignación de chats, bloqueo, etc.
     ***************************************************************/
    async function toggleChatAssignment(phoneNumber) {
      try {
        console.log('Iniciando toggle de asignación para:', phoneNumber);
        const token = sessionStorage.getItem('token');

        const response = await fetch('/toggle-chat-assignment', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ phoneNumber })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.message || 'Error al cambiar la asignación del chat');
        }

        console.log('Respuesta toggle:', result);

        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.textContent = result.message || 'Estado de asignación actualizado correctamente';
        const messagesContainer = document.getElementById('messagesContainer');
        if (messagesContainer) {
          messagesContainer.appendChild(successDiv);
          setTimeout(() => successDiv.remove(), 3000);
        }

        await loadChat(phoneNumber);
        return result;

      } catch (error) {
        console.error('Error en toggleChatAssignment:', error);
        showError(error.message || 'Error al cambiar la asignación del chat');
        throw error;
      }
    }

    async function checkChatAssignment(phoneNumber, assignButton) {
      try {
        console.log('Verificando asignación para:', phoneNumber);
        const token = sessionStorage.getItem('token');
        const response = await fetch(`/chat-assignment/${phoneNumber}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Error al verificar la asignación del chat');
        }

        const { assigned, assignedTo } = await response.json();
        const currentUser = sessionStorage.getItem('username');
        const userType = sessionStorage.getItem('userType');

        console.log('Estado de asignación:', { assigned, assignedTo, currentUser, userType });

        if (assigned) {
          if (assignedTo === currentUser || userType === 'admin' || userType === 'gerente') {
            assignButton.textContent = 'Desasignar Chat';
            assignButton.classList.add('assigned');
            assignButton.disabled = false;
          } else {
            assignButton.textContent = `Asignado a ${assignedTo}`;
            assignButton.disabled = true;
            assignButton.classList.add('disabled');
          }
        } else {
          assignButton.textContent = 'Asignar Chat';
          assignButton.classList.remove('assigned', 'disabled');
          assignButton.disabled = false;
        }

        updateMessageControls(assigned, assignedTo);
        return { assigned, assignedTo };

      } catch (error) {
        console.error('Error en checkChatAssignment:', error);
        showError('Error al verificar el estado de asignación');
        return { assigned: false, assignedTo: null };
      }
    }

    async function toggleBlockNumber(phoneNumber, isCurrentlyBlocked) {
      try {
        const token = sessionStorage.getItem('token');
        if (isCurrentlyBlocked) {
          const response = await fetch(`/block-number/${phoneNumber}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.message || 'Error al desbloquear');
          }
          console.log(data.message);

        } else {
          const response = await fetch('/block-number', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ phoneNumber })
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.message || 'Error al bloquear');
          }
          console.log(data.message);
        }

      } catch (error) {
        console.error('Error en toggleBlockNumber:', error);
        alert('No se pudo cambiar el estado de bloqueo: ' + error.message);
      }
    }

    async function deleteChat(phoneNumber) {
      try {
        const token = sessionStorage.getItem('token');
        const response = await fetch(`/delete-chat/${phoneNumber}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.message || 'Error al eliminar el chat');
        }

        console.log(data.message);
        alert(data.message);

      } catch (error) {
        console.error('Error en deleteChat:', error);
        alert('No se pudo eliminar el chat: ' + error.message);
      }
    }

    function updateMessageControls(assigned, assignedTo) {
      const currentUser = sessionStorage.getItem('username');
      const userType = sessionStorage.getItem('userType');
      const controls = ['messageInput', 'sendButton', 'scheduleButton', 'noteButton', 'uploadButton'];

      const hasAccess = !assigned || assignedTo === currentUser || userType === 'admin' || userType === 'gerente';

      controls.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.disabled = !hasAccess;
          if (!hasAccess && id === 'messageInput') {
            element.value = 'Chat asignado a ' + assignedTo;
          }
        }
      });

      const inputContainer = document.querySelector('.message-input');
      if (inputContainer) {
        inputContainer.style.backgroundColor = hasAccess ? 'white' : '#f5f5f5';
      }
    }

    /***************************************************************
     * 15. Modales y etiquetas
     ***************************************************************/

    async function loadTags() {
      try {
        const token = sessionStorage.getItem('token');
        if (!token) throw new Error('No se encontró token de autenticación');

        // 1. Petición de TODAS las etiquetas
        const allTagsResp = await fetch('/api/etiquetas', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        if (!allTagsResp.ok) {
          throw new Error('Error al obtener la lista de etiquetas');
        }
        const allTags = await allTagsResp.json();
        console.log('Todas las etiquetas:', allTags); // <-- Depura en consola

        // 2. Petición de etiquetas asignadas (solo si hay phoneNumber)
        let chatTags = [];
        if (window.currentPhoneNumber) {
          const assignedTagsResp = await fetch(`/api/chat/etiquetas/${window.currentPhoneNumber}`, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          if (!assignedTagsResp.ok) {
            throw new Error('Error al obtener etiquetas del chat');
          }
          chatTags = await assignedTagsResp.json();
        }
        console.log('Etiquetas asignadas a este chat:', chatTags);

        // 3. Ordenamos si queremos
        const sortedAllTags = allTags.sort((a, b) => (a.prioridad || 0) - (b.prioridad || 0));

        // 4. Limpiamos contenedores en el modal
        const availableList = document.getElementById('availableTagsList');
        const assignedList = document.getElementById('assignedTagsList');
        if (!availableList || !assignedList) {
          console.error('No se encontraron <div> de availableTagsList o assignedTagsList en el DOM.');
          return;
        }
        availableList.innerHTML = '';
        assignedList.innerHTML = '';

        // 5. Recorremos todas las etiquetas y verificamos si están asignadas
        sortedAllTags.forEach(tag => {
          const isAssigned = chatTags.some(ct => ct.id === tag.id && ct.activo);
          const tagElement = createTagElement(tag, isAssigned);
          if (isAssigned) {
            assignedList.appendChild(tagElement);
          } else {
            availableList.appendChild(tagElement);
          }
        });

      } catch (error) {
        console.error('Error en loadTags():', error);
        showError('Error al cargar las etiquetas: ' + error.message);
      }
    }


    function toggleNoteModal() {
      const noteModal = document.getElementById('noteModal');
      noteModal.style.display = "block";
      document.getElementById('noteText').value = '';
      document.getElementById('noteText').focus();
    }

    function toggleAddUserModal() {
      const modal = document.getElementById('addUserModal');
      modal.style.display = 'flex';
    }

    async function createUser() {
      try {
        const nombreCompleto = document.getElementById('newNombreCompleto').value.trim();
        const username = document.getElementById('newUsername').value.trim();
        const password = document.getElementById('newPassword').value.trim();
        const email = document.getElementById('newEmail').value.trim();
        const whatsapp = document.getElementById('newWhatsapp').value.trim();
        const userType = document.getElementById('userType').value;

        if (!nombreCompleto || !username || !password) {
          showError('Por favor completa los campos obligatorios (*)');
          return;
        }

        if (password.length < 6) {
          showError('La contraseña debe tener al menos 6 caracteres');
          return;
        }

        const response = await fetch('/api/usuarios', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${sessionStorage.getItem('token')}`
          },
          body: JSON.stringify({
            nombre_completo: nombreCompleto,
            nombre_usuario: username,
            password: password,
            email: email || null,
            numero_whatsapp: whatsapp || null,
            tipo_usuario: userType,
            activo: true
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Error al crear el usuario');
        }

        const result = await response.json();

        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.textContent = '✅ Usuario creado correctamente';
        successDiv.style.cssText = 'position:fixed; top:20px; right:20px; background:#10b981; color:white; padding:15px 20px; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1); z-index:9999; font-weight:500;';
        document.body.appendChild(successDiv);

        setTimeout(() => successDiv.remove(), 3000);

        document.getElementById('addUserModal').style.display = 'none';
        document.getElementById('newNombreCompleto').value = '';
        document.getElementById('newUsername').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('newEmail').value = '';
        document.getElementById('newWhatsapp').value = '';
        document.getElementById('userType').value = 'operador';

      } catch (error) {
        console.error('Error:', error);
        showError('Error al crear el usuario: ' + error.message);
      }
    }



    function initModals() {
      scheduleModal = document.getElementById('scheduleModal');
      noteModal = document.getElementById('noteModal');

      const modals = [
        { modal: document.getElementById('addUserModal'), name: 'addUser' },
        { modal: document.getElementById('tagModal'), name: 'tag' },
        { modal: scheduleModal, name: 'schedule' },
        { modal: noteModal, name: 'note' }
      ];

      modals.forEach(({ modal, name }) => {
        if (modal) {
          const closeBtn = modal.querySelector('.close');
          if (closeBtn) {
            closeBtn.onclick = () => {
              modal.style.display = 'none';
              if (name === 'tag') {
                loadTags(true).catch(error => {
                  console.error('Error al recargar etiquetas:', error);
                });
              }
            };
          }
        }
      });

      window.onclick = (event) => {
        modals.forEach(({ modal, name }) => {
          if (event.target === modal) {
            modal.style.display = 'none';
            if (name === 'tag') {
              loadTags(true).catch(error => {
                console.error('Error al recargar etiquetas:', error);
              });
            }
          }
        });
      };
    }

    async function addNewTag() {
      try {
        const name = document.getElementById('newTagName').value.trim();
        const color = document.getElementById('newTagColor').value;

        if (!name) {
          showError('El nombre de la etiqueta es requerido');
          return;
        }

        const response = await fetchWithAuth('/api/etiquetas', {
          method: 'POST',
          body: JSON.stringify({ nombre: name, color })
        });

        if (!response.ok) throw new Error('Error al crear etiqueta');

        document.getElementById('newTagName').value = '';
        loadTags();
        showSuccess('Etiqueta creada correctamente');

      } catch (error) {
        console.error('Error:', error);
        showError('Error al crear la etiqueta');
      }
    }



    async function deleteTag(tagId) {
      const defaultTagIds = [1, 2, 3, 4, 5, 6];
      if (defaultTagIds.includes(tagId)) {
        showError('No se pueden eliminar las etiquetas predefinidas');
        return;
      }
      if (!confirm('¿Estás seguro de eliminar esta etiqueta?')) return;

      try {
        const response = await fetchWithAuth(`/api/etiquetas/${tagId}`, {
          method: 'DELETE'
        });
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Error al eliminar etiqueta');
        }
        loadTags();
        showSuccess('Etiqueta eliminada correctamente');
      } catch (error) {
        console.error('Error:', error);
        showError('Error al eliminar la etiqueta: ' + error.message);
      }
    }

    async function toggleTagForChat(phoneNumber, tagId) {
      try {
        const token = sessionStorage.getItem('token');
        const response = await fetch('/api/chat/etiqueta', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ numeroTelefono: phoneNumber, etiquetaId: tagId })
        });
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Error al modificar etiqueta');
        }
      } catch (error) {
        console.error('Error al modificar etiqueta:', error);
        throw error;
      }
    }

    /***************************************************************
     * 16. Vista de tabla, filtros, etc.
     ***************************************************************/
    function toggleView(view) {
      const chatContainer = document.querySelector('.whatsapp-container');
      const tableView = document.getElementById('tableView');
      const chatViewBtn = document.getElementById('chatViewBtn');
      const tableViewBtn = document.getElementById('tableViewBtn');

      if (view === 'chat') {
        chatContainer.style.display = 'flex';
        tableView.style.display = 'none';
        chatViewBtn.classList.add('active');
        tableViewBtn.classList.remove('active');
      } else {
        chatContainer.style.display = 'none';
        tableView.style.display = 'block';
        chatViewBtn.classList.remove('active');
        tableViewBtn.classList.add('active');
        loadTableView();
      }
    }

    async function loadTableView() {
      try {
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';

        const response = await fetchWithAuth('/chat-list');
        if (!response.ok) throw new Error('Error al cargar los chats');
        const chats = await response.json();

        const activeTagsContainer = document.createElement('div');
        activeTagsContainer.className = 'active-tags-container';
        tableBody.parentElement.insertBefore(activeTagsContainer, tableBody);

        for (const chat of chats) {
          try {
            const [tagsResponse, assignResponse, scheduledResponse, notesResponse] = await Promise.all([
              fetchWithAuth(`/api/chat/etiquetas/${chat.numero_telefono}`),
              fetchWithAuth(`/chat-assignment/${chat.numero_telefono}`),
              fetchWithAuth(`/scheduled-messages/${chat.numero_telefono}`),
              fetchWithAuth(`/notes/${chat.numero_telefono}`)
            ]);

            const tags = await tagsResponse.json();
            const assignInfo = await assignResponse.json();
            const scheduledMessages = await scheduledResponse.json();
            const notes = await notesResponse.json();

            const chatCard = document.createElement('div');
            chatCard.className = 'chat-card';
            chatCard.dataset.phone = chat.numero_telefono;

            const activeTags = tags.filter(tag => tag.activo);
            const tagsList = activeTags.map(tag => `
                <span class="table-tag" data-tag-id="${tag.id}" style="background-color: ${tag.color}">
                  ${tag.nombre}
                </span>
              `).join('');

            const hasScheduled = scheduledMessages.length > 0;
            const hasNotes = notes.length > 0;

            chatCard.innerHTML = `
                <div class="chat-card-header">
                  <div class="chat-card-info">
                    <h3 class="chat-card-phone">${formatPhoneNumber(chat.numero_telefono)}</h3>
                    <div class="chat-card-meta">
                      <span class="chat-status ${assignInfo.assigned ? 'assigned' : ''}">
                        ${assignInfo.assigned ? `Asignado a ${assignInfo.assignedTo}` : 'Sin asignar'}
                      </span>
                      ${hasScheduled
                ? `<span class="chat-badge scheduled">📅 ${scheduledMessages.length} programado${scheduledMessages.length > 1 ? 's' : ''}</span>`
                : ''
              }
                      ${hasNotes
                ? `<span class="chat-badge notes">📝 ${notes.length} nota${notes.length > 1 ? 's' : ''}</span>`
                : ''
              }
                    </div>
                  </div>
                </div>
                <div class="chat-card-content">
                  <div class="chat-message">${chat.ultimo_mensaje || 'Sin mensajes'}</div>
                  <div class="chat-time">${formatToSpecificTimeZone(chat.ultima_actividad)}</div>
                  <div class="chat-tags">${tagsList}</div>
                  ${(hasScheduled || hasNotes) ? `
                      <div class="chat-card-extra">
                        ${hasScheduled ? `
                          <div class="scheduled-preview">
                            <strong>Próximo mensaje programado:</strong>
                            ${scheduledMessages[0].mensaje.substring(0, 50)}...
                            <span class="scheduled-time">
                              ${formatToSpecificTimeZone(scheduledMessages[0].fecha_envio)}
                            </span>
                          </div>
                          ` : ''
                }
                        ${hasNotes ? `
                          <div class="notes-preview">
                            <strong>Última nota:</strong>
                            ${notes[0].nota.substring(0, 50)}...
                          </div>
                          ` : ''
                }
                      </div>
                    ` : ''
              }
                </div>
              `;

            chatCard.addEventListener('click', () => {
              loadChat(chat.numero_telefono);
              toggleView('chat');
            });

            tableBody.appendChild(chatCard);
          } catch (error) {
            console.error(`Error procesando chat ${chat.numero_telefono}:`, error);
            continue;
          }
        }

        initializeTableFilters();

      } catch (error) {
        console.error('Error al cargar la vista de tabla:', error);
        showError('Error al cargar la vista de tabla');
      }
    }

    const originalLoadChatList = loadChatList;
    window.loadChatList = async function (force = false) {
      try {
        console.log('🔄 Sincronizando lista de chats y vista de tabla');
        await originalLoadChatList(force);

        const tableView = document.getElementById('tableView');
        const tableViewButton = document.getElementById('tableViewBtn');
        const isTableViewActive = tableView &&
          tableView.style.display === 'block' &&
          tableViewButton &&
          tableViewButton.classList.contains('active');

        if (isTableViewActive) {
          console.log('🔍 Actualizando vista de tabla');
          await loadTableView();
        }
      } catch (error) {
        console.error('❌ Error en sincronización de lista y tabla:', error);
      }
    };

    function initializeTableFilters() {
      const existingFilter = document.querySelector('.table-filters');
      if (existingFilter) { existingFilter.remove(); }

      const filterContainer = document.createElement('div');
      filterContainer.className = 'table-filters';
      filterContainer.innerHTML = `
          <div class="filter-section">
            <input type="text" id="tableSearch" class="table-search" placeholder="Buscar en todos los campos...">
            <div id="tagFilters" class="tag-filter-container"></div>
          </div>
        `;
      const tableContainer = document.querySelector('.table-container');
      tableContainer.insertBefore(filterContainer, tableContainer.firstChild);

      document.getElementById('tableSearch').addEventListener('input', filterTable);
      loadTagFilters();
    }

    async function loadTagFilters() {
      try {
        const response = await fetchWithAuth('/api/etiquetas');
        const tags = await response.json();
        const tagFilters = document.getElementById('tagFilters');
        tagFilters.innerHTML = tags.map(tag => `
            <label class="tag-filter">
              <input type="checkbox" value="${tag.id}">
              <span class="tag-label" style="background-color: ${tag.color}">${tag.nombre}</span>
            </label>
          `).join('');
        tagFilters.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          checkbox.addEventListener('change', filterTable);
        });
      } catch (error) {
        console.error('Error al cargar filtros de etiquetas:', error);
      }
    }

    function filterTable() {
      const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
      const selectedTags = Array.from(document.querySelectorAll('#tagFilters input:checked')).map(checkbox => checkbox.value);

      const cards = document.querySelectorAll('.chat-card');
      cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        const tags = Array.from(card.querySelectorAll('.table-tag')).map(tag => tag.dataset.tagId);

        const matchesSearch = !searchTerm || text.includes(searchTerm);
        const matchesTags = selectedTags.length === 0 || selectedTags.some(tagId => tags.includes(tagId));

        card.style.display = matchesSearch && matchesTags ? 'block' : 'none';
      });
    }

    function initializeSortableColumns() {
      const headers = document.querySelectorAll('.chats-table th');
      headers.forEach((header, index) => {
        if (header.textContent !== 'Etiquetas') {
          header.style.cursor = 'pointer';
          header.addEventListener('click', () => sortTable(index));
          header.innerHTML += ' <span class="sort-indicator">↕️</span>';
        }
      });
    }

    let currentSortColumn = null;
    let sortAscending = true;
    function sortTable(columnIndex) {
      const tbody = document.getElementById('tableBody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      if (currentSortColumn === columnIndex) {
        sortAscending = !sortAscending;
      } else {
        sortAscending = true;
        currentSortColumn = columnIndex;
      }

      document.querySelectorAll('.sort-indicator').forEach(indicator => { indicator.textContent = '↕️'; });
      const currentHeader = document.querySelectorAll('th')[columnIndex];
      currentHeader.querySelector('.sort-indicator').textContent = sortAscending ? '↑' : '↓';

      rows.sort((a, b) => {
        const aValue = a.children[columnIndex].textContent;
        const bValue = b.children[columnIndex].textContent;
        if (isDate(aValue) && isDate(bValue)) {
          return sortAscending ? new Date(aValue) - new Date(bValue) : new Date(bValue) - new Date(aValue);
        }
        return sortAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
      });
      rows.forEach(row => tbody.appendChild(row));
    }

    function isDate(value) { return !isNaN(Date.parse(value)); }

    /***************************************************************
     * 15. Funciones de mensajes masivos (bulkMessageModal)
     ***************************************************************/
    function initBulkMessageModal() {
      const modal = document.getElementById('bulkMessageModal');
      const container = document.getElementById('bulkMessageContainer');
      if (modal && container) {
        console.log('Inicializando modal de mensajes masivos');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(window.BulkMessageSender));

        const closeButtons = modal.querySelectorAll('.close');
        closeButtons.forEach(closeBtn => {
          closeBtn.onclick = function () {
            modal.style.display = 'none';
          };
        });

        function debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        }

        const debouncedSendMessage = debounce(async () => {
          try {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            const token = sessionStorage.getItem('token');
            if (!message || !window.currentPhoneNumber) return;
            const response = await fetch('/send-message', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                phoneNumber: window.currentPhoneNumber,
                message: message,
                userId: sessionStorage.getItem('userId'),
                username: sessionStorage.getItem('username')
              })
            });
            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.message || 'Error al enviar el mensaje');
            }
            input.value = '';
          } catch (error) {
            console.error('Error al enviar mensaje:', error);
            showError('Error al enviar el mensaje: ' + error.message);
          }
        }, 250);
        window.sendMessage = debouncedSendMessage;

        window.addEventListener('click', function (event) {
          if (event.target === modal) { modal.style.display = 'none'; }
        });
      }
    }

    function setupBulkMessageModal() {
      const modal = document.getElementById('bulkMessageModal');
      const container = document.getElementById('bulkMessageContainer');
      if (!modal || !container) {
        console.warn('No se encontró el modal o el contenedor de mensajes masivos');
        return;
      }
      try {
        console.log('Inicializando modal de mensajes masivos');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(BulkMessageSender));
        const closeButtons = modal.querySelectorAll('.close');
        closeButtons.forEach(closeBtn => {
          closeBtn.onclick = () => { modal.style.display = 'none'; };
        });
      } catch (error) {
        console.error('Error al inicializar modal de mensajes masivos:', error);
      }
    }

    /***************************************************************
     * 16. Inicialización de la aplicación (initializeApp)
     ***************************************************************/
    async function initializeApp() {
      try {
        if (!checkAuth()) {
          console.log('No hay autenticación, redirigiendo a login');
          return;
        }
        const elements = checkDOMElements();
        if (!elements.chatList) { throw new Error('Elemento chatList no encontrado en el DOM'); }

        console.log('Inicializando socket...');
        await initializeSocket();

        console.log('Inicializando componentes básicos...');
        initEventListeners();
        initModals();
        initTagModal(); // Asegúrate de que exista en /js/tags.js
        initEmojiPicker();

        console.log('Inicializando componentes React y modales...');
        setupBulkMessageModal();
        initNewChatButton();

        console.log('Cargando datos iniciales...');
        await loadChatList();
        sortChatItemsByTimestamp(); // Para consistencia visual

        console.log('Desactivando/ajustando setInterval repetitivos...');
        // Comenta o elimina cualquier setInterval extra.

        console.log('Configurando event listeners globales...');
        configureGlobalEventListeners();

        console.log('Iniciando verificación periódica del token...');
        startTokenValidation();

        console.log('Aplicación inicializada correctamente');
      } catch (error) {
        console.error('Error en la inicialización:', error);
        showError('Error al iniciar la aplicación: ' + error.message);
      }
    }

    /**
     * Verifica periódicamente si el token sigue siendo válido
     */
    function startTokenValidation() {
      // Verificar cada 30 segundos si el token sigue siendo válido
      setInterval(() => {
        checkAuth();
      }, 30000); // 30 segundos
    }

    function checkDOMElements() {
      const elements = {
        chatList: document.getElementById('chatList'),
        searchBox: document.querySelector('.search-box'),
        messagesContainer: document.getElementById('messagesContainer')
      };
      console.log('Elementos del DOM:', {
        chatListExists: !!elements.chatList,
        searchBoxExists: !!elements.searchBox,
        messagesContainerExists: !!elements.messagesContainer
      });
      return elements;
    }

    wireTopMenu();

    function configureGlobalEventListeners() {
      const qrModal = document.getElementById('whatsappQrModal');
      if (qrModal) {
        qrModal.addEventListener('click', (e) => {
          if (e.target === qrModal) {
            qrModal.style.display = 'none';
            isQRModalOpen = false;
          }
        });
      }
      const chatViewBtn = document.getElementById('chatViewBtn');
      const tableViewBtn = document.getElementById('tableViewBtn');

      if (chatViewBtn) chatViewBtn.onclick = () => toggleView('chat');
      if (tableViewBtn) tableViewBtn.onclick = () => toggleView('table');

      window.addEventListener('click', (event) => {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => { if (event.target === modal) { modal.style.display = 'none'; } });
      });

      // >>> Listener global para refrescar etiquetas del chat-list <<<
      window.addEventListener('tagsUpdated', (ev) => {
        const phone = ev && ev.detail && ev.detail.phoneNumber;

        // Si no nos pasan número, recargamos todo (lista y tabla si está abierta)
        if (!phone) {
          loadChatList(true);
          const tableView = document.getElementById('tableView');
          const tableViewBtn = document.getElementById('tableViewBtn');
          const isTableActive = tableView && tableView.style.display === 'block' &&
            tableViewBtn && tableViewBtn.classList.contains('active');
          if (isTableActive) { loadTableView(); }
          return;
        }

        // Si sí hay número, actualizamos SOLO ese item del chat-list
        const item = document.querySelector(`.chat-list-item[data-phone-number="${phone}"]`);
        if (item) {
          const container = item.querySelector('.chat-list-tag-container');
          if (container) renderTagsForChatItem(phone, container);
        } else {
          // Si ese chat no está en la lista (p. ej. recién creado), recargamos
          loadChatList(true);
        }

        // Si el chat abierto coincide, opcional: refrescar el header
        if (window.currentPhoneNumber === phone) {
          loadChat(phone).catch(() => { });
        }
      });
    }




    // ========== GESTIÓN DE PASAJEROS ==========
    window.pasajerosAdultos = [];
    window.pasajerosMenores = [];

    function agregarAdulto() {
      const index = window.pasajerosAdultos.length;
      window.pasajerosAdultos.push({ nombre: '', edad: '' });
      renderizarPasajeros();
    }

    function agregarMenor() {
      const index = window.pasajerosMenores.length;
      window.pasajerosMenores.push({ nombre: '', edad: '' });
      renderizarPasajeros();
    }

    function eliminarAdulto(index) {
      window.pasajerosAdultos.splice(index, 1);
      renderizarPasajeros();
    }

    function eliminarMenor(index) {
      window.pasajerosMenores.splice(index, 1);
      renderizarPasajeros();
    }

    function renderizarPasajeros() {
      const adultosContainer = document.getElementById('nr_adultos_container');
      const menoresContainer = document.getElementById('nr_menores_container');

      // Renderizar adultos
      adultosContainer.innerHTML = window.pasajerosAdultos.map((p, i) => `
        <div class="flex gap-2">
          <input type="text" placeholder="Nombre completo" value="${p.nombre}"
                 onchange="window.pasajerosAdultos[${i}].nombre = this.value"
                 class="flex-1 rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
          <input type="number" placeholder="Edad" value="${p.edad}" min="18" max="99"
                 onchange="window.pasajerosAdultos[${i}].edad = this.value"
                 class="w-20 rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
          <button type="button" onclick="eliminarAdulto(${i})"
                  class="rounded-lg bg-red-600 px-3 py-2 text-white hover:bg-red-700">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      `).join('');

      // Renderizar menores
      menoresContainer.innerHTML = window.pasajerosMenores.map((p, i) => `
        <div class="flex gap-2">
          <input type="text" placeholder="Nombre completo" value="${p.nombre}"
                 onchange="window.pasajerosMenores[${i}].nombre = this.value"
                 class="flex-1 rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
          <input type="number" placeholder="Edad" value="${p.edad}" min="0" max="17"
                 onchange="window.pasajerosMenores[${i}].edad = this.value"
                 class="w-20 rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
          <button type="button" onclick="eliminarMenor(${i})"
                  class="rounded-lg bg-red-600 px-3 py-2 text-white hover:bg-red-700">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      `).join('');
    }

    // Cargar proveedores
    async function cargarProveedoresModal() {
      try {
        const res = await fetchWithAuth('/api/proveedores?activos=true');
        if (!res.ok) return;

        const data = await res.json();
        const proveedores = data.proveedores || [];

        const select = document.getElementById('nr_proveedor_id');
        select.innerHTML = '<option value="">(sin proveedor)</option>' +
          proveedores.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
      } catch (err) {
        console.error('Error cargando proveedores:', err);
      }
    }

    // Cargar vendedores (solo si es admin o gerente)
    async function cargarVendedoresModal() {
      const userType = sessionStorage.getItem('userType');
      const vendedorContainer = document.getElementById('nr_vendedor_container');

      if (userType !== 'admin' && userType !== 'gerente') {
        vendedorContainer.style.display = 'none';
        return;
      }

      vendedorContainer.style.display = 'block';

      try {
        const res = await fetchWithAuth('/api/usuarios?activos=true');
        if (!res.ok) return;

        const data = await res.json();
        const usuarios = data.usuarios || [];

        const select = document.getElementById('nr_vendedor_id');
        const userId = sessionStorage.getItem('userId');

        select.innerHTML = '<option value="">(sin asignar)</option>' +
          usuarios.map(u => {
            const selected = u.id == userId ? 'selected' : '';
            return `<option value="${u.id}" ${selected}>${u.nombre_completo || u.nombre_usuario} (${u.tipo_usuario})</option>`;
          }).join('');
      } catch (err) {
        console.error('Error cargando vendedores:', err);
      }
    }

    async function cargarClientesModal() {
      try {
        const res = await fetchWithAuth('/contacts?limit=1000');
        if (!res.ok) return;

        const data = await res.json();
        const contactos = data.contacts || [];

        // Guardar contactos en variable global para búsqueda
        window.clientesDisponibles = contactos;

        // Llenar datalist para búsqueda
        const datalist = document.getElementById('nr_clientes_datalist');
        datalist.innerHTML = contactos.map(c => {
          const display = `${c.nombre || c.numero_telefono} (${c.numero_telefono})`;
          return `<option value="${display}" data-id="${c.id}" data-telefono="${c.numero_telefono}" data-nombre="${c.nombre || c.numero_telefono}">`;
        }).join('');

        // Evento de cambio en el input de búsqueda
        const searchInput = document.getElementById('nr_cliente_search');
        if (!searchInput.__changeHooked) {
          searchInput.__changeHooked = true;
          searchInput.addEventListener('input', (e) => {
            const valorBuscado = e.target.value;

            // Buscar cliente que coincida
            const clienteEncontrado = contactos.find(c => {
              const display = `${c.nombre || c.numero_telefono} (${c.numero_telefono})`;
              return display === valorBuscado || c.numero_telefono === valorBuscado;
            });

            if (clienteEncontrado) {
              document.getElementById('nr_cliente_select').value = clienteEncontrado.id;
              document.getElementById('nr_cliente_tel').value = clienteEncontrado.numero_telefono;
              document.getElementById('nr_cliente_tel_display').value = clienteEncontrado.numero_telefono;
              document.getElementById('nr_cliente_nombre').value = clienteEncontrado.nombre || clienteEncontrado.numero_telefono;
              document.getElementById('nr_contacto_id').value = clienteEncontrado.id;
            }
          });

          // Evento al perder el foco - validar que sea un cliente válido
          searchInput.addEventListener('blur', (e) => {
            const valorBuscado = e.target.value;
            const clienteEncontrado = contactos.find(c => {
              const display = `${c.nombre || c.numero_telefono} (${c.numero_telefono})`;
              return display === valorBuscado;
            });

            if (!clienteEncontrado && valorBuscado) {
              // Si no encontró coincidencia exacta, limpiar
              e.target.value = '';
              document.getElementById('nr_cliente_select').value = '';
              document.getElementById('nr_cliente_tel').value = '';
              document.getElementById('nr_cliente_tel_display').value = '';
              document.getElementById('nr_cliente_nombre').value = '';
              document.getElementById('nr_contacto_id').value = '';
            }
          });
        }
      } catch (err) {
        console.error('Error cargando clientes:', err);
      }
    }

    async function onNuevaReservaClick() {
      const phone = window.currentPhoneNumber || '';
      const modal = document.getElementById('modalNuevaReserva');
      const $ = (id) => document.getElementById(id);

      // Cerrar modal al hacer clic en el fondo
      if (!modal.__clickOutsideHooked) {
        modal.__clickOutsideHooked = true;
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        });
      }

      // Cargar proveedores y vendedores
      await cargarProveedoresModal();
      await cargarVendedoresModal();
      await cargarClientesModal();

      // Inicializar con 2 adultos por defecto
      window.pasajerosAdultos = [{ nombre: '', edad: '' }, { nombre: '', edad: '' }];
      window.pasajerosMenores = [];
      renderizarPasajeros();

      // Rellenar cliente desde /contacts/:phone
      let nombre = formatPhoneNumber(phone);
      let contactoId = null;

      try {
        const res = await fetchWithAuth(`/contacts/${phone}`);
        if (res.ok) {
          const js = await res.json();
          const d = js?.data || js;
          if (d?.nombre) nombre = d.nombre;
          if (d?.id) contactoId = d.id;
        }
      } catch (e) {
        console.warn('No pude obtener contacto:', e.message);
      }

      // Folio interno auto (editable)
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const rnd = String(Math.floor(Math.random() * 9999)).padStart(4, '0');
      const folioInterno = `R-${y}${m}-${rnd}`;

      // Pinta en el modal
      $('nr_cliente_nombre').value = nombre;
      $('nr_cliente_tel').value = formatPhoneNumber(phone);
      $('nr_cliente_tel_display').value = formatPhoneNumber(phone);
      $('nr_contacto_id').value = contactoId || '';
      $('nr_folio_interno').value = folioInterno;
      $('nr_folio_proveedor').value = '';

      // Pre-seleccionar cliente en el input de búsqueda si existe
      if (contactoId && phone) {
        const searchInput = $('nr_cliente_search');
        const displayValue = `${nombre} (${formatPhoneNumber(phone)})`;
        searchInput.value = displayValue;
        $('nr_cliente_select').value = contactoId;
      } else if (phone && !contactoId) {
        // Si hay teléfono pero no contacto_id, mostrar solo el teléfono
        const searchInput = $('nr_cliente_search');
        searchInput.value = formatPhoneNumber(phone);
      }

      // Limpia campos viaje
      $('nr_destino').value = '';
      $('nr_metodo_pago').value = 'TRANSFERENCIA';
      $('nr_check_in').value = '';
      $('nr_check_out').value = '';

      // Ítem opcional
      $('nr_proveedor_id').value = '';
      $('nr_tipo_item').value = '';
      $('nr_desc_item').value = '';
      $('nr_precio_neto').value = '';
      $('nr_precio_cliente').value = '';

      // Mostrar modal
      modal.style.display = 'flex';

      // Botón auto-rellenar desde cotizaciones (una sola vez)
      const btnAuto = $('btn_autorellenar_coti');
      if (!btnAuto.__hooked) {
        btnAuto.__hooked = true;
        btnAuto.addEventListener('click', async () => {
          try {
            const telefono = $('nr_cliente_tel').value || phone;
            if (!telefono) {
              alert('No hay teléfono del cliente');
              return;
            }

            // Abrir modal de selección
            await abrirModalCotizaciones(telefono);
          } catch (err) {
            console.error('Error auto-rellenando:', err);
            alert('Error al cargar cotización: ' + err.message);
          }
        });
      }

      // Enlace submit (una sola vez)
      const form = $('formNuevaReserva');
      if (!form.__hooked) {
        form.__hooked = true;
        form.addEventListener('submit', async (ev) => {
          ev.preventDefault();
          try {
            // Construir ocupación con nombres completos
            const ocupacion = {
              adultos: window.pasajerosAdultos.filter(p => p.nombre.trim()).map(p => ({
                nombre: p.nombre.trim(),
                edad: Number(p.edad) || 0
              })),
              menores: window.pasajerosMenores.filter(p => p.nombre.trim()).map(p => ({
                nombre: p.nombre.trim(),
                edad: Number(p.edad) || 0
              }))
            };

            // Vendedor (si es admin puede asignar, si no, auto-asignarse)
            const userType = sessionStorage.getItem('userType');
            const userId = sessionStorage.getItem('userId');
            let vendedorId = null;

            if (userType === 'admin' || userType === 'gerente') {
              vendedorId = $('nr_vendedor_id').value || null;
            } else {
              vendedorId = userId;
            }

            const payload = {
              contacto_id: $('nr_contacto_id').value || null,  // si viene null, el backend puede resolver por teléfono
              numero_telefono: phone,                           // respaldo para backend
              vendedor_id: vendedorId,
              destino: $('nr_destino').value.trim(),
              check_in: $('nr_check_in').value || null,
              check_out: $('nr_check_out').value || null,
              ocupacion,
              metodo_pago: $('nr_metodo_pago').value,
              folio_interno: $('nr_folio_interno').value.trim(),
              folio_proveedor: $('nr_folio_proveedor').value.trim() || null,
              items: []
            };

            // Ítem opcional
            const tipo = $('nr_tipo_item').value;
            const provId = $('nr_proveedor_id').value;
            const desc = $('nr_desc_item').value.trim();
            const neto = $('nr_precio_neto').value;
            const cli = $('nr_precio_cliente').value;

            if (tipo && provId && neto && cli) {
              payload.items.push({
                proveedor_id: Number(provId),
                tipo,
                descripcion: desc || null,
                precio_neto: Number(neto),
                precio_cliente: Number(cli)
                // precio_proveedor lo calculará el backend con el % según método/proveedor
              });
            }

            const resp = await fetchWithAuth('/reservas', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!resp.ok) {
              const err = await resp.json().catch(() => ({}));
              throw new Error(err?.message || 'No se pudo crear la reserva');
            }

            const data = await resp.json();
            showSuccess('Reserva creada correctamente.');
            modal.style.display = 'none';

            // (Opcional) Mensaje al chat confirmando alta interna
            const texto = `✅ *Reserva interna creada*\nFolio: *${payload.folio_interno}*\nDestino: *${payload.destino || 'por definir'}*\nMétodo: *${payload.metodo_pago}*\n\nAhora puedes generar el *plan de pagos* desde el menú 💳.`;
            try {
              await fetchWithAuth('/send-message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  phoneNumber: phone,
                  message: texto
                })
              });
            } catch { /* sin bloqueo */ }

          } catch (e) {
            console.error(e);
            showError(e.message || 'Error creando reserva');
          }
        });
      }
    }

    function onPagosClick() {
      // Abre la vista de pagos global con filtro por cliente actual (si ya la tienes)
      const phone = window.currentPhoneNumber || '';
      // Si tienes página dedicada:
      window.open(`/promos.html?tab=pagos&phone=${encodeURIComponent(phone)}`, '_blank');

      // Si prefieres modal interno, aquí invocarías tu modalPagos(...) con phone.
    }


    // ====== MENÚ SUPERIOR: abrir/cerrar y acciones ======
    function wireTopMenu() {
      const btn = document.getElementById('menuToggleBtn');
      const menu = document.getElementById('dropdownMenu');
      const btnNueva = document.getElementById('menuNuevaReserva');
      const btnPagos = document.getElementById('menuPagos');

      if (!btn || !menu) return;

      btn.onclick = (e) => {
        e.stopPropagation();
        menu.classList.toggle('show'); // usa la clase .show del CSS
      };

      // Cierra si haces click fuera
      document.addEventListener('click', () => {
        menu.classList.remove('show');
      });

      if (btnNueva) {
        btnNueva.onclick = (e) => {
          e.stopPropagation();
          onNuevaReservaClick();       // misma función que usaremos en el menú dinámico
          menu.classList.remove('show');
        };
      }
      if (btnPagos) {
        btnPagos.onclick = (e) => {
          e.stopPropagation();
          onPagosClick();              // misma función que usaremos en el menú dinámico
          menu.classList.remove('show');
        };
      }
    }


    // ===== MODAL DE COTIZACIONES =====
    let cotizacionesGlobales = [];

    async function abrirModalCotizaciones(telefono) {
      const modal = document.getElementById('modalSeleccionarCotizacion');
      const listContainer = document.getElementById('cotizaciones_list');
      const countSpan = document.getElementById('cotizaciones_count');

      // Mostrar modal
      modal.style.display = 'flex';

      // Cargar cotizaciones (sin límite para mostrar todas)
      try {
        const res = await fetchWithAuth(`/api/cotizaciones/${telefono}?limit=1000`);
        if (!res.ok) throw new Error('Error cargando cotizaciones');

        const data = await res.json();
        cotizacionesGlobales = data.cotizaciones || [];

        if (cotizacionesGlobales.length === 0) {
          listContainer.innerHTML = `
            <div style="text-align:center; color:#9ca3af; padding:60px 20px;">
              <svg style="width:64px; height:64px; margin:0 auto 16px; opacity:0.3;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              <p style="font-size:16px; margin:0; font-weight:500;">No hay cotizaciones disponibles</p>
              <p style="font-size:14px; margin:8px 0 0; color:#6b7280;">Las cotizaciones expiran después de 24 horas</p>
            </div>
          `;
          countSpan.textContent = '0 cotizaciones disponibles';
          return;
        }

        renderizarCotizaciones(cotizacionesGlobales);
        countSpan.textContent = `${cotizacionesGlobales.length} cotizaciones disponibles`;

      } catch (err) {
        console.error('Error cargando cotizaciones:', err);
        listContainer.innerHTML = `
          <div style="text-align:center; color:#ef4444; padding:60px 20px;">
            <p style="font-size:16px; margin:0; font-weight:500;">❌ Error al cargar cotizaciones</p>
            <p style="font-size:14px; margin:8px 0 0;">${err.message}</p>
          </div>
        `;
      }
    }

    function renderizarCotizaciones(cotizaciones) {
      const listContainer = document.getElementById('cotizaciones_list');

      if (cotizaciones.length === 0) {
        listContainer.innerHTML = `
          <div style="text-align:center; color:#9ca3af; padding:40px 20px;">
            <p style="font-size:14px; margin:0;">No se encontraron cotizaciones con ese criterio</p>
          </div>
        `;
        return;
      }

      listContainer.innerHTML = cotizaciones.map((c, index) => {
        const datos = c.datos_cotizacion || {};
        const tipo = c.tipo === 'PROMO' ? 'Promo' : 'Personalizada';
        const tipoColor = c.tipo === 'PROMO' ? '#10b981' : '#6366f1';
        const tipoIcon = c.tipo === 'PROMO' ? '🏖️' : '📋';

        const destino = datos.destino || 'Sin destino';
        const checkIn = datos.check_in || datos.fecha_salida_from || '';
        const checkOut = datos.check_out || datos.fecha_salida_to || '';
        const numOpciones = datos.num_opciones || 0;
        const plan = datos.plan || '';
        const transporte = datos.transporte || '';

        const fecha = new Date(c.created_at).toLocaleString('es-MX', {
          day: '2-digit',
          month: 'short',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        return `
          <div onclick="seleccionarCotizacion(${index})" style="background:white; border:2px solid #e5e7eb; border-radius:12px; padding:20px; margin-bottom:16px; cursor:pointer; transition:all 0.2s; position:relative;" onmouseover="this.style.borderColor='${tipoColor}'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">

            <!-- Badge tipo -->
            <div style="position:absolute; top:16px; right:16px;">
              <span style="background:${tipoColor}; color:white; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600;">
                ${tipoIcon} ${tipo}
              </span>
            </div>

            <!-- Destino -->
            <h3 style="margin:0 0 12px 0; font-size:20px; font-weight:700; color:#111827; padding-right:120px;">
              🌴 ${destino}
            </h3>

            <!-- Info grid -->
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:12px;">
              ${checkIn && checkOut ? `
                <div style="display:flex; align-items:center; gap:8px;">
                  <svg style="width:18px; height:18px; color:#6b7280;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                  <span style="font-size:14px; color:#374151;">
                    <strong>${checkIn}</strong> a <strong>${checkOut}</strong>
                  </span>
                </div>
              ` : ''}

              ${numOpciones > 0 ? `
                <div style="display:flex; align-items:center; gap:8px;">
                  <svg style="width:18px; height:18px; color:#6b7280;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                  </svg>
                  <span style="font-size:14px; color:#374151;">
                    <strong>${numOpciones}</strong> opciones de hotel
                  </span>
                </div>
              ` : ''}

              ${plan ? `
                <div style="display:flex; align-items:center; gap:8px;">
                  <svg style="width:18px; height:18px; color:#6b7280;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                  </svg>
                  <span style="font-size:14px; color:#374151;">${plan}</span>
                </div>
              ` : ''}

              ${transporte ? `
                <div style="display:flex; align-items:center; gap:8px;">
                  <svg style="width:18px; height:18px; color:#6b7280;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                  </svg>
                  <span style="font-size:14px; color:#374151;">${transporte}</span>
                </div>
              ` : ''}
            </div>

            <!-- Footer -->
            <div style="display:flex; justify-content:space-between; align-items:center; padding-top:12px; border-top:1px solid #e5e7eb;">
              <span style="font-size:12px; color:#9ca3af; display:flex; align-items:center; gap:6px;">
                <svg style="width:14px; height:14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                ${fecha}
              </span>
              <span style="color:${tipoColor}; font-size:13px; font-weight:600;">
                Click para seleccionar →
              </span>
            </div>

          </div>
        `;
      }).join('');
    }

    function filtrarCotizaciones() {
      const searchTerm = document.getElementById('cotizacion_search').value.toLowerCase();
      const filtradas = cotizacionesGlobales.filter(c => {
        const datos = c.datos_cotizacion || {};
        const destino = (datos.destino || '').toLowerCase();
        const checkIn = (datos.check_in || datos.fecha_salida_from || '').toLowerCase();
        const checkOut = (datos.check_out || datos.fecha_salida_to || '').toLowerCase();
        const tipo = (c.tipo || '').toLowerCase();

        return destino.includes(searchTerm) ||
               checkIn.includes(searchTerm) ||
               checkOut.includes(searchTerm) ||
               tipo.includes(searchTerm);
      });

      renderizarCotizaciones(filtradas);
      document.getElementById('cotizaciones_count').textContent = `${filtradas.length} de ${cotizacionesGlobales.length} cotizaciones`;
    }

    function seleccionarCotizacion(index) {
      const coti = cotizacionesGlobales[index];
      const datos = coti.datos_cotizacion || {};
      const $ = (id) => document.getElementById(id);

      // Auto-rellenar campos
      if (datos.destino) $('nr_destino').value = datos.destino;
      if (datos.check_in) $('nr_check_in').value = datos.check_in;
      if (datos.check_out) $('nr_check_out').value = datos.check_out;
      if (datos.ocupacion) {
        window.pasajerosAdultos = datos.ocupacion.adultos || [];
        window.pasajerosMenores = datos.ocupacion.menores || [];
        renderizarPasajeros();
      }

      // Cerrar modal
      document.getElementById('modalSeleccionarCotizacion').style.display = 'none';

      // Notificar éxito
      showSuccess('✅ Cotización cargada correctamente');
    }

    // Iniciar la aplicación
    initializeApp();
  </script>

</body>

</html>